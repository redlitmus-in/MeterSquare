import{j as e}from"./radix-ui-34961435.js";import{j as s,u as a,r as t}from"./react-vendor-3707ac94.js";import{C as r,a as i,b as c,c as l}from"./card-e62b6216.js";import{M as o,B as n,t as m}from"./index-12cad093.js";import{P as p}from"./PurchaseDetailsModal-bb395d44.js";import{A as d}from"./ApprovalModal-b4443bb7.js";import{p as u}from"./projectManagerService-fd1f363b.js";import{z as h,ax as _,R as j,a8 as x,ay as g,F as y,ah as v}from"./icons-2fde7931.js";import{m as f}from"./ui-vendor-42d562f2.js";import"./auth-f9290e45.js";import"./utils-8e4480a0.js";import"./forms-337f692b.js";import"./dialog-d443819a.js";import"./tabs-8d248749.js";import"./dateFormatter-3b370b4b.js";import"./label-d100d551.js";import"./textarea-ff7bd289.js";import"./radio-group-188286ff.js";import"./alert-409df19c.js";const N=()=>{const{purchaseId:N}=s(),w=a(),[b,S]=t.useState(null),[C,I]=t.useState(null),[P,k]=t.useState(!0),[D,F]=t.useState(!1),[O,q]=t.useState("details"),[z,M]=t.useState(!1),[A,R]=t.useState("approve"),[V,E]=t.useState(!1),L=async()=>{if(N)try{k(!0);const e=await u.getPurchaseDetails(parseInt(N)),s={purchase_id:e.purchase_id,purchase_details:{site_location:e.site_location,purpose:e.purpose,date:e.date,email_sent:e.email_sent,created_at:e.created_at,materials_summary:{total_materials:e.materials?.length||0,total_quantity:e.materials?.reduce((e,s)=>e+s.quantity,0)||0,total_cost:e.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0,categories:[...new Set(e.materials?.map(e=>e.category)||[])],materials:e.materials||[]}},procurement_statuses:e.approvals?.filter(e=>"procurement"===e.role)||[],project_manager_statuses:e.approvals?.filter(e=>"projectManager"===e.role)||[],latest_pm_proc_status:e.approvals?.[e.approvals.length-1]||{status:e.status||e.latest_status||"pending",role:null,date:null,decision_by:null,comments:null},summary:{total_procurement_statuses:0,total_pm_statuses:0,pm_approved_count:0,pm_rejected_count:0,pm_pending_count:0,procurement_approved_count:0,procurement_rejected_count:0,procurement_pending_count:0}};S(s);const a={purchase_id:s.purchase_id,site_location:s.purchase_details?.site_location||"",purpose:s.purchase_details?.purpose||"",date:s.purchase_details?.date||(new Date).toISOString(),email_sent:s.purchase_details?.email_sent||!1,created_at:s.purchase_details?.created_at||(new Date).toISOString(),current_workflow_status:"pending_pm_review",pm_status:null,pm_status_date:null,pm_comments:null,pm_rejection_reason:null,procurement_status:"approved",procurement_status_date:(new Date).toISOString(),procurement_comments:"",materials_summary:s.purchase_details?.materials_summary||{total_materials:0,total_quantity:0,total_cost:0,categories:[]},status_history:[]};I(a)}catch(e){m.error("Failed to fetch purchase details")}finally{k(!1)}};t.useEffect(()=>{L()},[N]);const H=b&&(!b.latest_pm_proc_status||!b.latest_pm_proc_status.role||"projectManager"!==b.latest_pm_proc_status.role&&"rejected"!==b.latest_pm_proc_status.status);return P?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(o,{variant:"pulse-wave",size:"lg"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Loading purchase details..."})]})}):b?e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs(f.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(n,{variant:"ghost",size:"icon",onClick:()=>w("/project-manager"),children:e.jsx(_,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900",children:["Purchase #",b.purchase_id]}),e.jsxs("p",{className:"text-gray-500 mt-1",children:[b.purchase_details?.site_location||"N/A"," â€¢ ",b.purchase_details?.purpose||"N/A"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[H&&e.jsxs(e.Fragment,{children:[e.jsx(n,{onClick:()=>{R("approve"),M(!0)},className:"bg-green-600 hover:bg-green-700",disabled:V,children:"Approve Purchase"}),e.jsx(n,{onClick:()=>{R("reject"),M(!0)},variant:"destructive",disabled:V,children:"Reject Purchase"})]}),e.jsx(n,{onClick:L,variant:"outline",size:"icon",children:e.jsx(j,{className:"h-4 w-4"})}),e.jsx(n,{variant:"outline",size:"icon",children:e.jsx(x,{className:"h-4 w-4"})}),e.jsx(n,{variant:"outline",size:"icon",children:e.jsx(g,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(r,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>{q("details"),F(!0)},children:[e.jsx(c,{children:e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-5 w-5"}),"View Details"]})}),e.jsx(i,{children:e.jsx("p",{className:"text-gray-600",children:"View complete purchase details and materials"})})]}),e.jsxs(r,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>{q("history"),F(!0)},children:[e.jsx(c,{children:e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-5 w-5"}),"View History"]})}),e.jsx(i,{children:e.jsx("p",{className:"text-gray-600",children:"View approval history and timeline"})})]})]}),e.jsx(p,{isOpen:D,onClose:()=>F(!1),purchaseId:N?parseInt(N):null,mode:O}),C&&e.jsx(d,{isOpen:z,onClose:()=>M(!1),purchase:C,mode:A,onConfirm:async e=>{try{let s;if(E(!0),s="approve"===e.action?await u.approvePurchase(e.purchaseId,e.comments):await u.rejectPurchase(e.purchaseId,e.rejectionReason||"",e.comments),!s.success)throw new Error(s.error||"Operation failed");m.success(s.message||`Purchase ${e.action}d successfully`),await L(),M(!1)}catch(s){m.error(s.response?.data?.error||s.message||"Failed to process request")}finally{E(!1)}},isLoading:V})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsx(r,{children:e.jsxs(i,{className:"text-center py-12",children:[e.jsx(h,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Purchase Not Found"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"The requested purchase could not be found."}),e.jsx(n,{onClick:()=>w("/project-manager"),children:"Return to Dashboard"})]})})})})};export{N as default};
