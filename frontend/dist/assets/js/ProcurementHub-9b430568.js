import{j as e}from"./radix-ui-34961435.js";import{r as s,u as t}from"./react-vendor-3707ac94.js";import{b as a,a as r,B as l,M as i,t as c,A as n,u as d}from"./index-12cad093.js";import{C as o,a as m,b as x,c as u}from"./card-e62b6216.js";import{S as h}from"./separator-a0f6b9f9.js";import{m as p}from"./ui-vendor-42d562f2.js";import{F as g,o as j,g as N,ag as f,E as v,ah as y,V as b,M as w,ai as _,aj as S,I as P,b as C,ak as q,Q as D,al as E,U as k,k as A,c as M,am as L,a8 as R,z as T,l as $,v as F,i as I,j as V,T as z,an as U,A as O,ao as H,ap as B,aq as W,G,t as Q,X as Y,a2 as Z,q as J,ar as K,R as X,as as ee,a9 as se,at as te,au as ae,u as re}from"./icons-2fde7931.js";import{D as le,a as ie,b as ce,c as ne,e as de,d as oe}from"./dialog-d443819a.js";import{T as me,a as xe,b as ue,c as he}from"./tabs-8d248749.js";import{I as pe}from"./input-dbd0a11e.js";import{T as ge}from"./textarea-ff7bd289.js";import{L as je}from"./label-d100d551.js";import{S as Ne,a as fe,b as ve,c as ye,d as be}from"./select-767f455e.js";import{_ as we}from"./auth-f9290e45.js";import{F as _e}from"./export-utils-ef0ca69a.js";import"./utils-8e4480a0.js";import"./forms-337f692b.js";const Se=new class{async getPurchases(){try{const e=await a.get("/all_procurement");if(e.data.success)return e.data.procurement||[];throw new Error(e.data.message||"Failed to fetch purchases")}catch(e){if(!e.response)throw new Error("Unable to connect to server. Please check if the backend is running.");if(404===e.response?.status)throw new Error("API endpoint not found. Please check backend configuration.");if(401===e.response?.status)throw new Error("Authentication required. Please login again.");throw e}}async getPurchaseDetails(e){try{const s=await a.get(`/purchase/${e}`);if(s.data){if(void 0!==s.data.success){if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to fetch purchase details")}return s.data}throw new Error("Failed to fetch purchase details")}catch(s){if(403===s.response?.status)throw new Error("You do not have permission to view this purchase request");if(404===s.response?.status)throw new Error("Purchase request not found");throw s}}async getPurchaseHistory(e){try{const s=await a.get(`/purchase_history/${e}`);if(s.data.success)return{purchase:s.data.purchase,latest_status:s.data.latest_status};throw new Error(s.data.message||"Failed to fetch purchase history")}catch(s){throw s}}async createPurchase(e){try{const s=await a.post("/purchase",e);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to create purchase")}catch(s){throw s}}async updatePurchase(e,s){try{const t=JSON.parse(localStorage.getItem("user")||"{}"),r=t.full_name||t.name||"Procurement Team",l={...s,status:"pending",sender_latest_status:"pending",email_sent:!1,last_modified_by:r,last_modified_at:(new Date).toISOString()},i=await a.put(`/purchase/${e}`,l);if(i.data.success)return i.data;throw new Error(i.data.message||"Failed to update purchase")}catch(t){if(404===t.response?.status)throw new Error("Purchase request not found");if(403===t.response?.status)throw new Error("You do not have permission to edit this purchase request");if(t.response?.data?.message)throw new Error(t.response.data.message);throw t}}async deletePurchase(e){try{const s=await a.delete(`/purchase/${e}`);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to delete purchase")}catch(s){throw s}}async sendApprovalEmail(e){try{const s=await a.get(`/purchase_email/${e}`);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to send email")}catch(s){throw s}}async approvePurchase(e,s){try{const s=await a.get(`/purchase_email/${e}`);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to approve purchase")}catch(t){throw t}}async rejectPurchase(e,s){try{const t=JSON.parse(localStorage.getItem("user")||"{}"),r=t.full_name||t.name||"Procurement Team",l={status:"rejected",sender_latest_status:"rejected",receiver_latest_status:"rejected",status_comments:s||"Rejected by Procurement",status_date:(new Date).toISOString(),status_sender:r,status_receiver:"Site Supervisor",status_role:"Procurement",last_modified_by:r,last_modified_at:(new Date).toISOString()},i=await a.put(`/purchase/${e}`,l);if(i.data.success)return i.data;throw new Error(i.data.message||"Failed to reject purchase")}catch(t){throw t}}async getDashboardMetrics(){try{const e=await a.get("/procurement/dashboard");if(e.data.success)return e.data.metrics;const s=await this.getPurchases();return this.calculateMetrics(s)}catch(e){const s=await this.getPurchases();return this.calculateMetrics(s)}}calculateMetrics(e){const s=e.reduce((e,s)=>e+(s.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0),0),t=e.filter(e=>!e.latest_status||"pending"===e.latest_status).length,a=e.filter(e=>"approved"===e.latest_status).length,r=e.filter(e=>"rejected"===e.latest_status).length;return{totalPurchaseValue:s,totalRequisitions:e.length,pendingRequisitions:t,approvedRequisitions:a,rejectedRequisitions:r,vendorPerformance:92,avgProcessingTime:1.5,costSavings:12450}}async getVendorQuotations(){try{const e=await a.get("/vendor_quotations");return e.data.success&&e.data.quotations||[]}catch(e){return[]}}async createVendorQuotation(e){try{const s=await a.post("/vendor_quotation",e);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to create vendor quotation")}catch(s){throw s}}},Pe=s.forwardRef(({purchase:t,onViewDetails:a,onViewHistory:c,onEdit:n,onSendEmail:d,onResendToPM:x,onResendToEst:u,isLoading:S=!1,emailSent:P=!1,sendingEmail:C=!1},q)=>{s.useState(!1),s.useState([]),s.useState(!1);const D=t.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0,E=t.sender_latest_status?t.sender_latest_status:t.latest_status?t.latest_status:t.status?t.status:"pending",k="rejected"===E&&(()=>{const e=t.approvals?.some(e=>"projectManager"===e.reviewer_role&&"rejected"===e.status),s="projectManager"===t.status_role&&"rejected"===t.sender_latest_status||"projectManager"===t.status_sender&&"rejected"===t.sender_latest_status;return e||s})(),A="rejected"===E&&(()=>{const e=t.approvals?.some(e=>"estimation"===e.reviewer_role&&"rejected"===e.status),s="estimation"===t.status_role&&"rejected"===t.sender_latest_status||"estimation"===t.status_sender&&"rejected"===t.sender_latest_status;return e||s})(),M=t.materials?.[0]?.priority||"medium";return e.jsx(p.div,{ref:q,initial:{opacity:0,y:20},animate:{opacity:1,y:0},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(o,{className:"shadow-md hover:shadow-lg transition-shadow border-0",children:e.jsxs(m,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-lg",children:e.jsx(g,{className:"w-4 h-4 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:t.prNumber||`PR-${t.purchase_id}`}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(t.date||t.created_at).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsxs("div",{className:"flex flex-col gap-1 items-end",children:[e.jsx(r,{className:`${(e=>{switch(e?.toLowerCase()){case"approved":case"completed":case"delivered":case"closed":case"finished":return"bg-green-100 text-green-800 border-green-200";case"rejected":return"bg-red-100 text-red-800 border-red-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"in_progress":case"under_review":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}})(E)} border`,children:E.toUpperCase()}),k&&e.jsx(r,{className:"bg-orange-100 text-orange-800 border-orange-200 border text-xs",children:"Rejected by PM"})]}),M&&e.jsx(r,{className:`${(e=>{switch(e?.toLowerCase()){case"urgent":return"bg-red-100 text-red-800 border-red-200";case"high":return"bg-orange-100 text-orange-800 border-orange-200";case"medium":return"bg-blue-100 text-blue-800 border-blue-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}})(M)} border text-xs`,children:M.toUpperCase()})]})]}),e.jsx(h,{className:"my-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(j,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"font-medium text-gray-900",children:t.project_id})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(N,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"font-medium text-gray-900",children:t.requested_by})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(f,{className:"w-3 h-3 text-gray-400"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:["AED ",D.toLocaleString()]})]}),t.materials&&e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(N,{className:"w-3 h-3 text-gray-400"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[t.materials.length," material",1!==t.materials.length?"s":""]})]}),t.materials&&t.materials.length>0&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-2",children:"Material Summary:"}),e.jsxs("div",{className:"space-y-1",children:[t.materials.slice(0,2).map((s,t)=>e.jsxs("div",{className:"text-xs text-gray-600",children:["• ",s.description," (",s.quantity," ",s.unit,")"]},s.material_id)),t.materials.length>2&&e.jsxs("div",{className:"text-xs text-gray-500 italic",children:["+",t.materials.length-2," more items..."]})]})]})]}),e.jsx(h,{className:"my-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 w-full",children:[a&&e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>a(t.purchase_id),disabled:S,className:"flex-1 h-7 text-xs flex items-center justify-center min-w-0",children:[e.jsx(v,{className:"w-3 h-3 mr-1"}),"Details"]}),c&&e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>c(t.purchase_id),disabled:S,className:"flex-1 h-7 text-xs flex items-center justify-center min-w-0",children:[e.jsx(y,{className:"w-3 h-3 mr-1"}),"History"]}),n&&("pending"===E||k||A)&&e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>n(t.purchase_id),disabled:S,title:"Edit Purchase Request",className:"flex-1 h-7 text-xs flex items-center justify-center min-w-0",children:[e.jsx(b,{className:"w-3 h-3 mr-1"}),"Edit"]})]}),!P&&"pending"===E&&d&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(l,{size:"sm",onClick:()=>d(t.purchase_id),disabled:S||C,className:"text-white w-full h-7 text-xs flex items-center justify-center",style:{backgroundColor:C?"#64748b":"#243d8a"},onMouseEnter:e=>!C&&(e.currentTarget.style.backgroundColor="#1a2d66"),onMouseLeave:e=>!C&&(e.currentTarget.style.backgroundColor="#243d8a"),title:"Send to Project Manager",children:C?e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"pulse-wave",size:"sm",className:"mr-1"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-3 h-3 mr-1"}),"Send to PM"]})})}),k&&x&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(l,{size:"sm",onClick:()=>x(t.purchase_id),disabled:S,className:"bg-red-600 hover:bg-red-700 text-white w-full h-7 text-xs flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed",title:"Resend to Project Manager after revision",children:S?e.jsx(i,{variant:"pulse-wave",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-3 h-3 mr-1"}),"Resend to PM"]})})}),A&&u&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(l,{size:"sm",onClick:()=>u(t.purchase_id),disabled:S,className:"text-white w-full h-7 text-xs flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed",style:{backgroundColor:S?"#94a3b8":"#243d8a"},onMouseEnter:e=>!S&&(e.currentTarget.style.backgroundColor="#1a2d66"),onMouseLeave:e=>!S&&(e.currentTarget.style.backgroundColor="#243d8a"),title:"Send to Project Manager after Estimation revision",children:S?e.jsx(i,{variant:"pulse-wave",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-3 h-3 mr-1"}),"Send PM"]})})}),P&&e.jsxs("div",{className:"flex items-center justify-center gap-2 py-2 bg-green-50 rounded-lg",children:[e.jsx(_,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-700",children:"Sent to Project Manager"})]})]})]})})})});Pe.displayName="PurchaseCard";const Ce=({isOpen:t,onClose:a,purchaseId:d,mode:x="details",activeTab:u})=>{const[v,b]=s.useState(null),[_,G]=s.useState(null),[Q,Y]=s.useState(!1),[Z,J]=s.useState("history"===x?"history":"details");s.useEffect(()=>{t&&d?(b(null),Y(!0),K(),J("history"===x?"history":"details")):(b(null),Y(!1))},[t,d,x]);const K=async()=>{if(d)try{if(Y(!0),"history"===x){const{purchase:e,latest_status:s}=await Se.getPurchaseHistory(d);let t=!1;const a=e?.history?.some(e=>{const s=e.status?.toLowerCase(),t=e.action?.toLowerCase()||"",a=e.comments?.toLowerCase()||"",r=e.comment?.toLowerCase()||"",l=e.role?.toLowerCase()||"";if("completed"===s||"complete"===s)return!0;const i=`${t} ${a} ${r}`.toLowerCase();return!!(i.includes("payment completed")||i.includes("acknowledgement")||i.includes("payment done")||i.includes("completed"))||"accounts"===l&&("completed"===s||"acknowledged"===s)}),r=e?.status?.toLowerCase(),l=s?.status?.toLowerCase();"completed"!==r&&"complete"!==r&&"completed"!==l&&"complete"!==l||(t=!0);const i=e?.approvals?.some?.(e=>"accounts"===e.role&&("completed"===e.status||"acknowledged"===e.status));t=t||a||i||"completed"===u,t?(b({...e,status:"completed"}),G({...s,status:"completed"})):(b(e),G(s))}else{const e=await Se.getPurchaseDetails(d);e.purchase?(b(e.purchase),G(e.latest_status)):b(e)}}catch(e){c.error(e.message||"Failed to fetch purchase details")}finally{Y(!1)}},X=e=>{switch(e?.toLowerCase()){case"approved":case"complete":case"completed":return"bg-green-100 text-green-800 border-green-200";case"rejected":return"bg-red-100 text-red-800 border-red-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"under_review":case"in_progress":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},ee=s=>{switch(s?.toLowerCase()){case"approved":case"complete":case"completed":return e.jsx(I,{className:"w-4 h-4 text-green-600"});case"rejected":return e.jsx(F,{className:"w-4 h-4 text-red-600"});case"pending":return e.jsx(A,{className:"w-4 h-4 text-yellow-600"});case"under_review":case"in_progress":return e.jsx(T,{className:"w-4 h-4 text-blue-600"});default:return e.jsx(A,{className:"w-4 h-4 text-gray-600"})}},se=e=>{if(!e)return"Unknown file";const s=e.split("/");return s[s.length-1]||"Attached document"},te=e=>({approved:"APPROVED",complete:"COMPLETED",completed:"COMPLETED",rejected:"REJECTED",pending:"PENDING",under_review:"UNDER REVIEW",in_progress:"IN PROGRESS"}[e?.toLowerCase()]||e?.toUpperCase()||"PENDING"),ae=v?.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0;return e.jsx(le,{open:t,onOpenChange:a,children:e.jsxs(ie,{className:"max-w-5xl max-h-[95vh] h-[95vh] overflow-hidden flex flex-col p-0 bg-gray-50",children:[e.jsx(ce,{className:"px-6 py-5 bg-gradient-to-r from-red-50 to-red-100 flex-shrink-0 shadow-lg border-b border-red-200",children:e.jsxs(ne,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-white/50 rounded-lg backdrop-blur",children:e.jsx(g,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-gray-900 text-lg font-semibold",children:"Purchase Request Details"}),v&&e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsxs(r,{className:"bg-red-100 text-red-700 border-red-300 hover:bg-red-200",children:[e.jsx(S,{className:"w-3 h-3 mr-1"}),"PR-",v.purchase_id]}),e.jsxs(r,{className:`${X(_?.status||v.status||v.latest_status)} border`,children:[ee(_?.status||v.status||v.latest_status),e.jsx("span",{className:"ml-1",children:te(_?.status||v.status||v.latest_status||"pending")})]})]})]})]}),e.jsx("div",{className:"flex items-center gap-2"})]})}),Q?e.jsx("div",{className:"flex items-center justify-center flex-1 bg-white",children:e.jsxs("div",{className:"text-center",children:[e.jsx(i,{variant:"pulse-wave",size:"lg"}),e.jsx("p",{className:"text-gray-600 mt-4",children:"Loading purchase details..."})]})}):v?e.jsx("div",{className:"flex-1 overflow-hidden flex flex-col",children:e.jsxs(me,{value:Z,onValueChange:J,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"bg-white border-b px-6 pt-4",children:e.jsx(xe,{className:`grid w-full ${"history"===x?"grid-cols-1":"grid-cols-3"} max-w-2xl mx-auto bg-gray-100`,children:"history"===x?e.jsxs(ue,{value:"history",className:"data-[state=active]:bg-white data-[state=active]:shadow-sm",children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),"History"]}):e.jsxs(e.Fragment,{children:[e.jsxs(ue,{value:"details",className:"data-[state=active]:bg-white data-[state=active]:shadow-sm",children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Details"]}),e.jsxs(ue,{value:"materials",className:"data-[state=active]:bg-white data-[state=active]:shadow-sm",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"Materials"]}),e.jsxs(ue,{value:"status",className:"data-[state=active]:bg-white data-[state=active]:shadow-sm",children:[e.jsx(C,{className:"w-4 h-4 mr-2"}),"Latest Status"]})]})})}),"history"!==x&&e.jsx(he,{value:"details",className:"flex-1 overflow-hidden mt-0 bg-white",children:e.jsx("div",{className:"h-full overflow-y-auto p-6",children:e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsx(o,{className:"border-0 shadow-sm bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium",children:"Total Amount"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-900 mt-1",children:["AED ",ae.toLocaleString()]})]}),e.jsx("div",{className:"p-3 bg-blue-200/30 rounded-lg",children:e.jsx(f,{className:"w-6 h-6 text-blue-700"})})]})})}),e.jsx(o,{className:"border-0 shadow-sm bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"Materials"}),e.jsxs("p",{className:"text-2xl font-bold text-purple-900 mt-1",children:[v.materials?.length||0," Items"]})]}),e.jsx("div",{className:"p-3 bg-purple-200/30 rounded-lg",children:e.jsx(N,{className:"w-6 h-6 text-purple-700"})})]})})}),e.jsx(o,{className:"border-0 shadow-sm bg-gradient-to-br from-green-50 to-green-100",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"Email Status"}),e.jsx("p",{className:"text-lg font-bold text-green-900 mt-1",children:v.email_sent?"Sent ✓":"Pending"})]}),e.jsx("div",{className:"p-3 bg-green-200/30 rounded-lg",children:e.jsx(w,{className:"w-6 h-6 text-green-700"})})]})})})]}),e.jsx(o,{className:"border-0 shadow-sm",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:e.jsx(P,{className:"w-5 h-5 text-red-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Basic Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(j,{className:"w-5 h-5 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Project ID"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:v.project_id})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(q,{className:"w-5 h-5 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Requested By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:v.requested_by})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(D,{className:"w-5 h-5 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Site Location"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:v.site_location})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(E,{className:"w-5 h-5 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Request Date"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:new Date(v.date||v.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(k,{className:"w-5 h-5 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Created By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:v.created_by})]})]}),v.last_modified_by&&e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(A,{className:"w-5 h-5 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Last Modified By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:v.last_modified_by})]})]})]})]})]})}),e.jsx(o,{className:"border-0 shadow-sm",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:e.jsx(M,{className:"w-5 h-5 text-amber-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Purpose"})]}),e.jsx("div",{className:"bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-lg border border-amber-200",children:e.jsx("p",{className:"text-sm text-gray-800 leading-relaxed",children:v.purpose||"No purpose specified"})})]})}),e.jsx(o,{className:"border-0 shadow-sm",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(L,{className:"w-5 h-5 text-purple-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Document Attachments"})]}),v.file_path?e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[(s=>{if(!s)return e.jsx(H,{className:"h-5 w-5 text-gray-400"});const t=s.split(".").pop()?.toLowerCase();switch(t){case"pdf":return e.jsx(g,{className:"h-5 w-5 text-red-500"});case"doc":case"docx":return e.jsx(g,{className:"h-5 w-5 text-blue-500"});case"xls":case"xlsx":return e.jsx(W,{className:"h-5 w-5 text-green-500"});case"png":case"jpg":case"jpeg":case"gif":return e.jsx(B,{className:"h-5 w-5 text-purple-500"});default:return e.jsx(H,{className:"h-5 w-5 text-gray-400"})}})(v.file_path),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:se(v.file_path)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Uploaded by ",v.requested_by||"Site Supervisor"]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(l,{variant:"outline",size:"sm",className:"flex items-center gap-2",onClick:()=>(async e=>{if(e&&d)try{const s=await fetch(`${n}/download_files?key=procurement&id=${d}`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(!s.ok)throw new Error(`HTTP ${s.status}: Failed to get download URL`);const t=await s.json();let a=null;if(t.purchase_files&&t.purchase_files.length>0?a=t.purchase_files[0].public_url:t.accounts_files&&t.accounts_files.length>0&&(a=t.accounts_files[0].public_url),a){const s=document.createElement("a");s.href=a,s.download=se(e),s.target="_blank",document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("Download started")}else c.error("No file available for download")}catch(s){c.error(`Failed to download file: ${s instanceof Error?s.message:"Unknown error"}`)}})(v.file_path),children:[e.jsx(R,{className:"h-3.5 w-3.5"}),"Download"]})})]}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1 mt-3",children:[e.jsx(T,{className:"h-3 w-3"}),"Files are securely stored and can be accessed by authorized personnel only"]})]}):e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 text-center",children:[e.jsx(L,{className:"h-8 w-8 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No attachments uploaded"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Documents can be attached when creating purchase requests"})]})]})}),v.approvals?.action&&v.approvals.action.length>0&&e.jsx(o,{className:"border-0 shadow-sm",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx($,{className:"w-5 h-5 text-green-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Current Approval Status"})]}),e.jsx("div",{className:"space-y-3",children:v.approvals.action.slice(-1).map((s,t)=>e.jsx(p.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"relative",children:e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:shadow-md transition-all",children:[e.jsx("div",{className:"p-2 rounded-lg "+("approved"===s.status||"complete"===s.status||"completed"===s.status?"bg-green-100":"rejected"===s.status?"bg-red-100":"bg-yellow-100"),children:ee(s.status)}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:s.role?.replace(/([A-Z])/g," $1").trim()}),e.jsx(r,{className:`${X(s.status)} border`,children:te(s.status)})]}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date(s.timestamp).toLocaleString()})]}),s.comments&&e.jsx("div",{className:"bg-white p-3 rounded-lg mt-2",children:e.jsxs("p",{className:"text-sm text-gray-700 italic",children:['"',s.comments,'"']})})]})]})},t))})]})}),!v.email_sent&&"approved"!==v.status&&e.jsx(o,{className:"border-0 shadow-sm bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5 text-blue-600"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Available Actions"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{variant:"outline",onClick:()=>Se.rejectPurchase(v.purchase_id,"Cost exceeds budget"),className:"hover:bg-red-50 hover:text-red-600 hover:border-red-300",children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),"Reject"]}),e.jsxs(l,{onClick:()=>Se.approvePurchase(v.purchase_id),className:"bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Approve"]}),e.jsxs(l,{onClick:async()=>{if(d)try{await Se.sendApprovalEmail(d),c.success("Approval email sent to Project Manager"),a()}catch(e){c.error(e.message||"Failed to send email")}},className:"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Send to PM"]})]})]})})})]})})}),"history"!==x&&e.jsx(he,{value:"materials",className:"flex-1 overflow-hidden mt-0 bg-white",children:e.jsx("div",{className:"h-full overflow-y-auto p-6",children:v.materials&&v.materials.length>0?e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-4",children:[v.materials.map((s,t)=>e.jsx(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*t},children:e.jsx(o,{className:"border-0 shadow-sm hover:shadow-md transition-all",children:e.jsxs(m,{className:"p-5",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(V,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-lg",children:s.description}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Item #",t+1]})]})]}),e.jsx(r,{className:"bg-purple-100 text-purple-700 border-purple-200",children:s.category})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase",children:"Specification"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-1",children:s.specification})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium uppercase",children:"Quantity"}),e.jsxs("p",{className:"text-sm font-semibold text-blue-900 mt-1",children:[s.quantity," ",s.unit]})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-green-600 font-medium uppercase",children:"Unit Cost"}),e.jsxs("p",{className:"text-sm font-semibold text-green-900 mt-1",children:["AED ",s.cost.toLocaleString()]})]}),e.jsxs("div",{className:"bg-amber-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-amber-600 font-medium uppercase",children:"Total Cost"}),e.jsxs("p",{className:"text-sm font-bold text-amber-900 mt-1",children:["AED ",(s.quantity*s.cost).toLocaleString()]})]})]}),(s.priority||s.design_reference)&&e.jsxs("div",{className:"flex gap-4 mt-4 pt-4 border-t",children:[s.priority&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Priority:"}),e.jsx(r,{variant:"high"===s.priority.toLowerCase()?"destructive":"medium"===s.priority.toLowerCase()?"default":"secondary",children:s.priority.toUpperCase()})]}),s.design_reference&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Design Ref:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:s.design_reference})]})]})]})})},s.material_id)),e.jsx(o,{className:"border-2 border-green-200 bg-gradient-to-r from-green-50 to-emerald-50",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-green-100 rounded-lg",children:e.jsx(f,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Grand Total"}),e.jsxs("p",{className:"text-3xl font-bold text-gray-900",children:["AED ",ae.toLocaleString()]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[v.materials.length," Items"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"All prices inclusive"})]})]})})})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"p-4 bg-gray-100 rounded-full inline-block mb-4",children:e.jsx(N,{className:"w-16 h-16 text-gray-400"})}),e.jsx("p",{className:"text-lg font-medium text-gray-600",children:"No materials found"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"No materials have been added to this purchase request"})]})})})}),"history"!==x&&e.jsx(he,{value:"status",className:"flex-1 overflow-hidden mt-0 bg-white",children:e.jsx("div",{className:"h-full overflow-y-auto p-6",children:_?e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-6",children:[e.jsx(o,{className:"border-0 shadow-sm",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(C,{className:"w-5 h-5 text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Current Status Information"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wider font-medium",children:"Current Status"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs(r,{className:`${X(_.status)} border text-sm py-1 px-3`,children:[ee(_.status),e.jsx("span",{className:"ml-1",children:te(_.status||"pending")})]}),_.is_active&&e.jsxs(r,{className:"bg-green-100 text-green-700 border-green-200",children:[e.jsx(C,{className:"w-3 h-3 mr-1"}),"Active"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Status ID"}),e.jsxs("p",{className:"font-mono text-sm font-semibold text-gray-700",children:["#",_.status_id||"N/A"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(q,{className:"w-4 h-4 text-blue-600"}),e.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Decision Information"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600",children:"Current Role"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:_.role?.replace(/([A-Z])/g," $1").trim()||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600",children:"Decision By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:_.created_by||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600",children:"Decision Date"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:_.decision_date?new Date(_.decision_date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"})]})]})]}),e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg border border-purple-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(O,{className:"w-4 h-4 text-purple-600"}),e.jsx("p",{className:"text-sm font-medium text-purple-900",children:"Workflow Path"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-purple-600",children:"From (Sender)"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:_.sender?.replace(/([A-Z])/g," $1").trim()||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-purple-600",children:"To (Receiver)"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:_.receiver?.replace(/([A-Z])/g," $1").trim()||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-purple-600",children:"Purchase ID"}),e.jsxs("p",{className:"text-sm font-semibold text-gray-900",children:["PR-",_.purchase_id||"N/A"]})]})]})]})]}),_.comments&&e.jsx(o,{className:"border-0 shadow-sm bg-gradient-to-r from-amber-50 to-yellow-50",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:e.jsx(P,{className:"w-4 h-4 text-amber-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-amber-900 mb-2",children:"Comments"}),e.jsxs("p",{className:"text-sm text-amber-800 italic",children:['"',_.comments,'"']})]})]})})}),(_.rejection_reason||_.reject_category)&&e.jsx(o,{className:"border-0 shadow-sm bg-gradient-to-r from-red-50 to-pink-50",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:e.jsx(F,{className:"w-4 h-4 text-red-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-red-900 mb-2",children:"Rejection Details"}),_.rejection_reason&&e.jsx("p",{className:"text-sm text-red-800 mb-2",children:_.rejection_reason}),_.reject_category&&e.jsx(r,{variant:"destructive",children:_.reject_category})]})]})})})]})]})}),e.jsx(o,{className:"border-0 shadow-sm",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:e.jsx(A,{className:"w-5 h-5 text-gray-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Timeline"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Created At"})]}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:_.created_at?new Date(_.created_at).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Last Modified"})]}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:_.last_modified_at?new Date(_.last_modified_at).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"})]}),_.last_modified_by&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Modified By"})]}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:_.last_modified_by})]})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"p-4 bg-gray-100 rounded-full inline-block mb-4",children:e.jsx(T,{className:"w-16 h-16 text-gray-400"})}),e.jsx("p",{className:"text-lg font-medium text-gray-600",children:"No status information available"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Status details will appear here once available"})]})})})}),e.jsxs(he,{value:"history",className:"flex-1 overflow-y-auto mt-0",style:{maxHeight:"calc(90vh - 200px)"},children:[e.jsx("div",{className:"flex justify-center px-8 py-6",children:e.jsx(o,{className:"w-full max-w-4xl shadow-lg border border-gray-200",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-5 pb-3 border-b border-gray-200",children:[e.jsx(y,{className:"w-5 h-5 text-gray-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"History"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-8",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"w-4 h-4 text-blue-600"}),e.jsx("h3",{className:"font-medium text-gray-900 text-sm",children:"Purchase Details"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-4 h-4 text-green-600"}),e.jsx("h3",{className:"font-medium text-gray-900 text-sm",children:"Request Info"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-4 h-4 text-purple-600"}),e.jsx("h3",{className:"font-medium text-gray-900 text-sm",children:"Timeline Stats"})]})]}),e.jsx(h,{className:"my-3"}),e.jsxs("div",{className:"grid grid-cols-3 gap-8",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Purpose: "}),e.jsxs("span",{className:"text-gray-900",title:v?.purpose||"N/A",children:[v?.purpose?.substring(0,40)||"N/A",v?.purpose?.length>40?"...":""]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Requested by: "}),e.jsx("span",{className:"text-gray-900",children:v?.requested_by||"N/A"})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Total Steps: "}),e.jsx("span",{className:"text-gray-900 font-medium",children:v.approvals?.action?.length||0})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-8",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Location: "}),e.jsx("span",{className:"text-gray-900",children:v?.site_location||"N/A"})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Date: "}),e.jsx("span",{className:"text-gray-900",children:v?.date?new Date(v.date).toLocaleString("en-US",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0}):"N/A"})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Approvals: "}),e.jsx("span",{className:"text-green-600 font-medium",children:v.approvals?.action?.filter(e=>"approved"===e.status||"completed"===e.status).length||0})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-8",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Project: "}),e.jsxs("span",{className:"text-gray-900",children:["#",v?.project_id||"N/A"]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"TD Status: "}),e.jsx("span",{className:"text-gray-900",children:_?.status||v?.latest_status||"Pending"})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Rejections: "}),e.jsx("span",{className:"text-red-600 font-medium",children:v.approvals?.action?.filter(e=>"rejected"===e.status).length||0})]})]})]})]})})}),v.approvals?.action&&v.approvals.action.length>0?e.jsx("div",{className:"space-y-4",children:v.approvals.action.map((s,t)=>{const a=e=>{const s=e.role;if(!s)return"System";return{projectManager:"Project Manager",procurement:"Procurement",estimation:"Estimation",technicalDirector:"Technical Director",accounts:"Accounts",siteSupervisor:"Site Supervisor",mepSupervisor:"MEP Supervisor",design:"Design"}[s]||s.replace(/([A-Z])/g," $1").replace(/_/g," ").replace(/-/g," ").trim().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")};return e.jsxs("div",{className:"relative",children:[v.approvals?.action&&t<v.approvals.action.length-1&&e.jsx("div",{className:"absolute left-5 top-10 bottom-0 w-0.5 bg-gray-200"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center "+("approved"===s.status||"complete"===s.status||"completed"===s.status?"bg-green-100":"rejected"===s.status?"bg-red-100":"bg-yellow-100"),children:ee(s.status)})}),e.jsxs("div",{className:"flex-1 bg-white border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:a(s)}),e.jsx("p",{className:"text-sm text-gray-500",children:s.decided_by||"System"})]}),e.jsx(r,{className:`${X(s.status)} border`,children:te(s.status)})]}),e.jsx("p",{className:"text-sm text-gray-700 mt-2",children:(e=>{if(e.comments)return e.rejection_reason?`${e.comments} Reason: ${e.rejection_reason}`:e.comments;if(e.rejection_reason)return`Rejected: ${e.rejection_reason}`;const s=a(e);switch(e.status?.toLowerCase()){case"approved":return s.toLowerCase().includes("procurement")?"Procurement reviewed and sent to Project Manager for approval":`${s} approved the request`;case"rejected":return`${s} rejected the request`;case"pending":return`Awaiting review from ${s}`;default:return"All documents verified, moving to next step."}})(s)}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:new Date(s.timestamp).toLocaleString()})]})]})]},t)})}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(y,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"No approval history available"}),e.jsx("p",{className:"text-sm mt-1",children:"Approval history will appear here once processing begins"})]})]})]})}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(T,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"No purchase data available"})]})]})})},qe=({isOpen:t,onClose:a,purchase:r,onSave:i})=>{const[n,d]=s.useState(!1),[x,u]=s.useState({project_id:"",site_location:"",purpose:"",requested_by:"",materials:[]});s.useEffect(()=>{r&&u({project_id:String(r.project_id||""),site_location:String(r.site_location||""),purpose:String(r.purpose||""),requested_by:String(r.requested_by||""),materials:r.materials||[]})},[r]);const h=(e,s,t)=>{const a=[...x.materials];a[e]={...a[e],[s]:"quantity"===s||"cost"===s?Number(t):t},u({...x,materials:a})};return r?e.jsx(le,{open:t,onOpenChange:a,children:e.jsxs(ie,{className:"max-w-4xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx(ce,{children:e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5 text-red-600"}),"Edit Purchase Request - PR-",r.purchase_id]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-1",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{children:e.jsxs(m,{className:"pt-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(je,{htmlFor:"project_id",children:"Project ID *"}),e.jsx(pe,{id:"project_id",value:x.project_id,onChange:e=>u({...x,project_id:e.target.value}),placeholder:"Enter project ID"})]}),e.jsxs("div",{children:[e.jsx(je,{htmlFor:"site_location",children:"Site Location *"}),e.jsx(pe,{id:"site_location",value:x.site_location,onChange:e=>u({...x,site_location:e.target.value}),placeholder:"Enter site location"})]})]}),e.jsxs("div",{children:[e.jsx(je,{htmlFor:"requested_by",children:"Requested By"}),e.jsx(pe,{id:"requested_by",value:x.requested_by,disabled:!0,className:"bg-gray-50 cursor-not-allowed",title:"This field cannot be edited"})]}),e.jsxs("div",{children:[e.jsx(je,{htmlFor:"purpose",children:"Purpose *"}),e.jsx(ge,{id:"purpose",value:x.purpose,onChange:e=>u({...x,purpose:e.target.value}),placeholder:"Describe the purpose of this purchase request",rows:3})]})]})}),e.jsx(o,{children:e.jsxs(m,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Materials"}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e={material_id:Date.now(),description:"",quantity:1,unit:"pcs",cost:0,priority:"medium"};u({...x,materials:[...x.materials,e]})},children:[e.jsx(G,{className:"w-4 h-4 mr-1"}),"Add Material"]})]}),e.jsx("div",{className:"space-y-3",children:0===x.materials.length?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(N,{className:"w-12 h-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{children:"No materials added yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Material" to start'})]}):x.materials.map((s,t)=>e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-600",children:["Material #",t+1]}),e.jsx(l,{type:"button",variant:"ghost",size:"sm",onClick:()=>(e=>{const s=x.materials.filter((s,t)=>t!==e);u({...x,materials:s})})(t),className:"text-red-600 hover:text-red-700",children:e.jsx(Q,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(je,{children:"Description *"}),e.jsx(pe,{value:s.description,onChange:e=>h(t,"description",e.target.value),placeholder:"Material description"})]}),e.jsxs("div",{children:[e.jsx(je,{children:"Quantity *"}),e.jsx(pe,{type:"number",value:s.quantity,onChange:e=>h(t,"quantity",e.target.value),min:"1"})]}),e.jsxs("div",{children:[e.jsx(je,{children:"Unit"}),e.jsx(pe,{value:s.unit,onChange:e=>h(t,"unit",e.target.value),placeholder:"e.g., pcs, kg, m"})]}),e.jsxs("div",{children:[e.jsx(je,{children:"Unit Cost (AED)"}),e.jsx(pe,{type:"number",value:s.cost,onChange:e=>h(t,"cost",e.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx(je,{children:"Priority"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded-md",value:s.priority||"medium",onChange:e=>h(t,"priority",e.target.value),children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["Subtotal: ",e.jsxs("span",{className:"font-semibold",children:["AED ",(s.quantity*s.cost).toLocaleString()]})]})]},s.material_id))}),x.materials.length>0&&e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-semibold",children:"Total Amount:"}),e.jsxs("span",{className:"text-2xl font-bold text-red-600",children:["AED ",x.materials.reduce((e,s)=>e+s.quantity*s.cost,0).toLocaleString()]})]})})]})}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(T,{className:"w-5 h-5 text-amber-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-900",children:"Important Note"}),e.jsx("p",{className:"text-xs text-amber-700 mt-1",children:"After updating, this purchase request will need to be re-sent to the Project Manager for approval."})]})]})})]})}),e.jsxs(de,{className:"mt-4",children:[e.jsxs(l,{variant:"outline",onClick:a,disabled:n,children:[e.jsx(Y,{className:"w-4 h-4 mr-1"}),"Cancel"]}),e.jsx(l,{onClick:async()=>{if(!r)return;const e=String(x.project_id||""),s=String(x.site_location||""),t=String(x.purpose||"");if(String(x.requested_by||""),e.trim())if(s.trim())if(t.trim())if(0!==x.materials.length){for(let e=0;e<x.materials.length;e++){const s=x.materials[e];if(!s.description.trim())return void c.error(`Material ${e+1}: Description is required`);if(s.quantity<=0)return void c.error(`Material ${e+1}: Quantity must be greater than 0`);if(s.cost<0)return void c.error(`Material ${e+1}: Cost cannot be negative`)}try{d(!0);const e={project_id:String(x.project_id),site_location:String(x.site_location),purpose:String(x.purpose),materials:x.materials.map(e=>({...e,description:String(e.description),unit:String(e.unit||"pcs"),quantity:Number(e.quantity),cost:Number(e.cost),priority:String(e.priority||"medium")}))};await Se.updatePurchase(r.purchase_id,e),c.success("Purchase request updated successfully"),i(),a()}catch(l){c.error(l.message||"Failed to update purchase request")}finally{d(!1)}}else c.error("At least one material is required");else c.error("Purpose is required");else c.error("Site location is required");else c.error("Project ID is required")},disabled:n,className:"bg-red-600 hover:bg-red-700",children:n?e.jsx(e.Fragment,{children:"Updating..."}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-4 h-4 mr-1"}),"Update Purchase Request"]})})]})]})}):null},De=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),Ee=e=>`AED ${e.toLocaleString()}`,ke=()=>{t();const{user:a}=d(),[n,h]=s.useState("pending"),[j,v]=s.useState("all"),[y,b]=s.useState("all"),[w,_]=s.useState("all"),[S,P]=s.useState({min:"",max:""}),[C,q]=s.useState("all"),[E,k]=s.useState("date"),[M,L]=s.useState("desc"),[R,$]=s.useState(!1),[F,V]=s.useState([]),[U,O]=s.useState([]),[H,B]=s.useState([]),[G,Q]=s.useState(!0),[Y,Z]=s.useState(null),[ge,je]=s.useState("details"),[ke,Ae]=s.useState(!1),[Me,Le]=s.useState(new Set),[Re,Te]=s.useState(!1),[$e,Fe]=s.useState(null),[Ie,Ve]=s.useState(new Set),[ze,Ue]=s.useState(new Set),[Oe,He]=s.useState({isOpen:!1,purchaseId:null,message:"",isLoading:!1});s.useEffect(()=>{const e=setTimeout(()=>{Be()},100);return()=>clearTimeout(e)},[]),s.useEffect(()=>{We()},[n,j,y,w,S,C,E,M,F]);const Be=async()=>{try{Q(!0);let s=[],t={};try{s=await Se.getPurchases(),V(s);const e=new Set;s.forEach(s=>{("approved"===s.latest_status||s.approvals?.action?.some(e=>"procurement"===e.role&&"approved"===e.status))&&e.add(s.purchase_id)}),Le(e)}catch(e){V([]),c.error(e.message||"Failed to fetch purchase requests")}t={totalPurchaseValue:s.reduce((e,s)=>e+(s.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0),0),totalRequisitions:s.length,pendingRequisitions:s.filter(e=>!e.latest_status||"pending"===e.latest_status).length,vendorPerformance:95},B([{title:"Total Purchase Value",value:`AED ${(t?.totalPurchaseValue||0).toLocaleString()}`,change:12.5,icon:J,color:"bg-green-500",trend:"up"},{title:"Requisitions to Process",value:t?.totalRequisitions||s.length||0,change:-5.2,icon:g,color:"bg-red-500",trend:"down"},{title:"Pending Processing",value:t?.pendingRequisitions||0,change:25,icon:A,color:"bg-amber-500",trend:"up"},{title:"Vendor Performance",value:`${t?.vendorPerformance||0}%`,change:3.8,icon:K,color:"bg-purple-500",trend:"up"}])}catch(e){c.error("An unexpected error occurred"),V([]),B([{title:"Total Purchase Value",value:"AED 0",change:0,icon:J,color:"bg-green-500",trend:"up"},{title:"Requisitions to Process",value:0,change:0,icon:g,color:"bg-red-500",trend:"down"},{title:"Pending Processing",value:0,change:0,icon:A,color:"bg-amber-500",trend:"up"},{title:"Vendor Performance",value:"0%",change:0,icon:K,color:"bg-purple-500",trend:"up"}])}finally{Q(!1)}},We=()=>{let e=[...F];if(e.sort((e,s)=>{const t=e=>{const s=[e.last_modified_at,e.status_date,e.decision_date,e.created_at].filter(e=>e).map(e=>new Date(e).getTime());return Math.max(...s,new Date(e.created_at).getTime())},a=t(e);return t(s)-a}),"all"!==j&&(e=e.filter(e=>(e.materials?.[0]?.priority?.toLowerCase()||"medium")===j)),"all"!==y&&(e=e.filter(e=>e.project_id===y)),"all"!==w&&(e=e.filter(e=>e.site_location===w)),(S.min||S.max)&&(e=e.filter(e=>{const s=e.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0,t=S.min?parseFloat(S.min):0,a=S.max?parseFloat(S.max):1/0;return s>=t&&s<=a})),"all"!==C){const s=new Date;e=e.filter(e=>{const t=new Date(e.created_at),a=Math.ceil((s.getTime()-t.getTime())/864e5);switch(C){case"today":return 0===a;case"week":return a<=7;case"month":return a<=30;default:return!0}})}switch(n){case"pending":e=e.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status||"pending";return"completed"!==s&&"delivered"!==s&&"closed"!==s&&"finished"!==s&&(("pending"===s||"draft"===s)&&!Me.has(e.purchase_id))});break;case"approved":e=e.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;return"completed"!==s&&"delivered"!==s&&"closed"!==s&&"finished"!==s&&(!e.approvals?.action?.some(e=>"accounts"===e.role&&("completed"===e.status||"acknowledged"===e.status))&&("approved"===s||Me.has(e.purchase_id)||"projectManager"===e.status_receiver&&"procurement"===e.status_sender||"accounts"===e.status_receiver&&"completed"!==s||"technicalDirector"===e.status_receiver&&"approved"===s))});break;case"pm_rejected":e=e.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;if("completed"===s||"delivered"===s||"closed"===s||"finished"===s)return!1;const t=e.approvals?.action?.some(e=>"projectManager"===e.role&&"rejected"===e.status),a="projectManager"===e.status_role&&"rejected"===e.sender_latest_status||"projectManager"===e.status_sender&&"rejected"===e.sender_latest_status||"projectManager"===e.status_sender&&"rejected"===e.latest_status;return t||a});break;case"est_rejected":e=e.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;if("completed"===s||"delivered"===s||"closed"===s||"finished"===s)return!1;const t=e.approvals?.action?.some(e=>"estimation"===e.role&&"rejected"===e.status),a="estimation"===e.status_role&&"rejected"===e.sender_latest_status||"estimation"===e.status_sender&&"rejected"===e.sender_latest_status||"estimation"===e.status_sender&&"rejected"===e.latest_status;return t||a});break;case"completed":e=e.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;if("completed"===s||"delivered"===s||"closed"===s||"finished"===s)return!0;if(e.approvals?.action?.some(e=>"accounts"===e.role&&("completed"===e.status||"acknowledged"===e.status)))return!0;const t=e.approvals?.action?.[e.approvals.action.length-1];return!("accounts"!==t?.role||"completed"!==t.status&&!t.comments?.includes("completed"))});break;default:e=e.filter(e=>"pending"===(e.sender_latest_status||e.latest_status||e.status||"pending")&&!Me.has(e.purchase_id))}e.sort((e,s)=>{let t,a;switch(E){case"date":t=new Date(e.created_at).getTime(),a=new Date(s.created_at).getTime();break;case"amount":t=e.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0,a=s.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0;break;case"priority":const r={high:3,medium:2,low:1};t=r[e.materials?.[0]?.priority?.toLowerCase()||"medium"]||2,a=r[s.materials?.[0]?.priority?.toLowerCase()||"medium"]||2;break;case"project":t=e.project_id?.toLowerCase()||"",a=s.project_id?.toLowerCase()||"";break;case"location":t=e.site_location?.toLowerCase()||"",a=s.site_location?.toLowerCase()||"";break;default:t=e.purchase_id,a=s.purchase_id}return"string"==typeof t&&"string"==typeof a?"asc"===M?t.localeCompare(a):a.localeCompare(t):"asc"===M?t-a:a-t}),O(e)},Ge=e=>{Z(e),je("details"),Ae(!0)},Qe=e=>{Z(e),je("history"),Ae(!0)},Ye=e=>{const s=F.find(s=>s.purchase_id===e);if(!s)return void c.error("Purchase not found");const t=s.sender_latest_status||s.latest_status||s.status,a="pending"===t||"rejected"===t||"pm_rejected"===n||"est_rejected"===n;a||"approved"!==t?a||!Me.has(e)?(Fe(s),Te(!0)):c.error("Cannot edit purchase requests that have been sent for approval"):c.error("Cannot edit approved purchase requests")},Ze=e=>{He({isOpen:!0,purchaseId:e,message:"Send this purchase request to Project Manager for approval?"})},Je=async e=>{try{Ue(s=>new Set(s).add(e)),await Se.sendApprovalEmail(e),c.success("Purchase request resent to Project Manager for approval"),await Be()}catch(s){c.error(s.message||"Failed to resend email to Project Manager")}finally{Ue(s=>{const t=new Set(s);return t.delete(e),t})}},Ke=async e=>{try{const s=U.length>0?U:F,t=`${n.charAt(0).toUpperCase()+n.slice(1)} Purchase Requests`;switch(e){case"pdf":await(async(e,s="Purchase Requisitions Report")=>{const{jsPDF:t}=await we(()=>import("./export-utils-ef0ca69a.js").then(e=>e.j),["assets/js/export-utils-ef0ca69a.js","assets/js/auth-f9290e45.js","assets/js/react-vendor-3707ac94.js","assets/js/utils-8e4480a0.js"]),a=(await we(()=>import("./export-utils-ef0ca69a.js").then(e=>e.a),["assets/js/export-utils-ef0ca69a.js","assets/js/auth-f9290e45.js","assets/js/react-vendor-3707ac94.js","assets/js/utils-8e4480a0.js"])).default,r=new t;r.setFontSize(20),r.setTextColor(220,53,69),r.text(s,14,20),r.setFontSize(10),r.setTextColor(100),r.text(`Generated on: ${De(new Date)}`,14,30);const l=e.length,i=e.reduce((e,s)=>e+(s.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0),0);r.setFontSize(12),r.setTextColor(0),r.text(`Total Purchase Requests: ${l}`,14,40),r.text(`Total Value: ${Ee(i)}`,14,47),a(r,{startY:55,head:[["PR ID","Date","Project","Requested By","Location","Purpose","Total Amount","Status","Email Sent"]],body:e.map(e=>{const s=e.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0;return[`PR-${e.purchase_id}`,De(e.date||e.created_at),e.project_id,e.requested_by,e.site_location,e.purpose?.substring(0,30)+(e.purpose?.length>30?"...":""),Ee(s),(e.status||e.latest_status||"pending").toUpperCase(),e.email_sent?"Yes":"No"]}),theme:"grid",headStyles:{fillColor:[220,53,69],textColor:255,fontSize:9,fontStyle:"bold",halign:"center",valign:"middle"},bodyStyles:{fontSize:8,valign:"middle"},columnStyles:{0:{cellWidth:18,halign:"center"},1:{cellWidth:22,halign:"center"},2:{cellWidth:20,halign:"left"},3:{cellWidth:25,halign:"left"},4:{cellWidth:22,halign:"left"},5:{cellWidth:30,halign:"left"},6:{cellWidth:22,halign:"right"},7:{cellWidth:18,halign:"center"},8:{cellWidth:15,halign:"center"}},alternateRowStyles:{fillColor:[245,245,245]},margin:{top:10,left:10,right:10},tableWidth:"auto",styles:{overflow:"linebreak",cellPadding:2}});const c=r.getNumberOfPages();for(let n=1;n<=c;n++)r.setPage(n),r.setFontSize(10),r.setTextColor(150),r.text(`Page ${n} of ${c}`,r.internal.pageSize.getWidth()/2,r.internal.pageSize.getHeight()-10,{align:"center"});r.save(`procurement_report_${(new Date).toISOString().split("T")[0]}.pdf`)})(s,t),c.success("PDF exported successfully");break;case"excel":await(async e=>{const s=await we(()=>import("./export-utils-ef0ca69a.js").then(e=>e.x),["assets/js/export-utils-ef0ca69a.js","assets/js/auth-f9290e45.js","assets/js/react-vendor-3707ac94.js","assets/js/utils-8e4480a0.js"]),t=e.map(e=>{const s=e.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0;return{"PR ID":`PR-${e.purchase_id}`,Date:De(e.date||e.created_at),"Project ID":e.project_id,"Requested By":e.requested_by,"Created By":e.created_by,"Site Location":e.site_location,Purpose:e.purpose,"Total Amount (AED)":s,Status:(e.status||e.latest_status||"pending").toUpperCase(),"Email Sent":e.email_sent?"Yes":"No","Materials Count":e.materials?.length||0}}),a=[];e.forEach(e=>{e.materials?.forEach(s=>{a.push({"PR ID":`PR-${e.purchase_id}`,"Material ID":s.material_id,Description:s.description,Category:s.category,Specification:s.specification,Quantity:s.quantity,Unit:s.unit,"Unit Cost (AED)":s.cost,"Total Cost (AED)":s.quantity*s.cost,Priority:s.priority||"Normal","Design Reference":s.design_reference||""})})});const r=s.utils.book_new(),l=s.utils.json_to_sheet(t);if(s.utils.book_append_sheet(r,l,"Purchase Requests"),a.length>0){const e=s.utils.json_to_sheet(a);s.utils.book_append_sheet(r,e,"Materials")}const i=[{Metric:"Total Purchase Requests",Value:e.length},{Metric:"Total Value (AED)",Value:e.reduce((e,s)=>e+(s.materials?.reduce((e,s)=>e+s.quantity*s.cost,0)||0),0)},{Metric:"Pending Requests",Value:e.filter(e=>!e.latest_status||"pending"===e.latest_status).length},{Metric:"Approved Requests",Value:e.filter(e=>"approved"===e.latest_status).length},{Metric:"Rejected Requests",Value:e.filter(e=>"rejected"===e.latest_status).length},{Metric:"Report Generated",Value:(new Date).toLocaleString()}],c=s.utils.json_to_sheet(i);s.utils.book_append_sheet(r,c,"Summary");const n=s.write(r,{bookType:"xlsx",type:"array"}),d=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});_e.saveAs(d,`procurement_report_${(new Date).toISOString().split("T")[0]}.xlsx`)})(s,t),c.success("Excel file exported successfully")}}catch(s){c.error("Failed to export data")}};return G?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(i,{variant:"pulse-wave",size:"lg"}),e.jsx("p",{className:"text-gray-600 mt-4",children:"Loading procurement data..."})]})}):e.jsxs("div",{className:"p-6 space-y-6 bg-gray-50 min-h-screen",children:[e.jsx(p.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-red-50 to-red-100 rounded-xl shadow-xl p-6 text-gray-800 border border-red-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-white/20 rounded-lg backdrop-blur",children:e.jsx(N,{className:"w-8 h-8 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Procurement Hub"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Process purchase requisitions, manage vendor quotations, and handle approvals"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{variant:"outline",size:"icon",onClick:Be,title:"Refresh",children:e.jsx(X,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>Ke("pdf"),className:"gap-1",title:"Export as PDF",children:[e.jsx(g,{className:"w-4 h-4 text-red-600"}),"PDF"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>Ke("excel"),className:"gap-1",title:"Export as Excel",children:[e.jsx(W,{className:"w-4 h-4 text-green-600"}),"Excel"]})]})]})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:H.map((s,t)=>e.jsx(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*t},children:e.jsx(o,{className:"border-0 shadow-md hover:shadow-lg transition-shadow",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s.title}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:s.value}),e.jsxs("div",{className:"flex items-center gap-1 mt-2",children:["up"===s.trend?e.jsx(z,{className:"w-4 h-4 text-green-500"}):e.jsx(ee,{className:"w-4 h-4 text-red-500"}),e.jsxs("span",{className:"text-sm font-medium "+("up"===s.trend?"text-green-600":"text-red-600"),children:[s.change,"%"]})]})]}),e.jsx("div",{className:`p-3 rounded-lg ${s.color} bg-opacity-10`,children:e.jsx(s.icon,{className:`w-6 h-6 ${s.color.replace("bg-","text-")}`})})]})})})},s.title))}),e.jsxs(o,{className:"shadow-lg border-0",children:[e.jsxs(x,{className:"bg-gradient-to-r from-red-50 to-orange-50 border-b",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs(u,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-red-600"}),"Purchase Requisitions"]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(Ne,{value:j,onValueChange:v,children:[e.jsx(fe,{className:"w-32",children:e.jsx(ve,{placeholder:"Priority"})}),e.jsxs(ye,{children:[e.jsx(be,{value:"all",children:"All Priority"}),e.jsx(be,{value:"high",children:"High"}),e.jsx(be,{value:"medium",children:"Medium"}),e.jsx(be,{value:"low",children:"Low"})]})]}),e.jsxs(Ne,{value:E,onValueChange:k,children:[e.jsx(fe,{className:"w-32",children:e.jsx(ve,{placeholder:"Sort by"})}),e.jsxs(ye,{children:[e.jsx(be,{value:"date",children:"Date"}),e.jsx(be,{value:"amount",children:"Amount"}),e.jsx(be,{value:"priority",children:"Priority"}),e.jsx(be,{value:"project",children:"Project"}),e.jsx(be,{value:"location",children:"Location"})]})]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>L("asc"===M?"desc":"asc"),title:"Sort "+("asc"===M?"Descending":"Ascending"),children:[e.jsx(te,{className:"w-4 h-4"}),"asc"===M?"↑":"↓"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>$(!R),children:[e.jsx(ae,{className:"w-4 h-4 mr-1"}),R?"Hide":"More"," Filters"]})]})]}),R&&e.jsxs(p.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 p-4 bg-white/80 rounded-lg border border-red-200",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[e.jsx(N,{className:"w-4 h-4"}),"Project"]}),e.jsxs(Ne,{value:y,onValueChange:b,children:[e.jsx(fe,{children:e.jsx(ve,{placeholder:"All Projects"})}),e.jsxs(ye,{children:[e.jsx(be,{value:"all",children:"All Projects"}),[...new Set(F.map(e=>e.project_id).filter(Boolean))].map(s=>e.jsx(be,{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[e.jsx(D,{className:"w-4 h-4"}),"Location"]}),e.jsxs(Ne,{value:w,onValueChange:_,children:[e.jsx(fe,{children:e.jsx(ve,{placeholder:"All Locations"})}),e.jsxs(ye,{children:[e.jsx(be,{value:"all",children:"All Locations"}),[...new Set(F.map(e=>e.site_location).filter(Boolean))].map(s=>e.jsx(be,{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[e.jsx(re,{className:"w-4 h-4"}),"Date Range"]}),e.jsxs(Ne,{value:C,onValueChange:q,children:[e.jsx(fe,{children:e.jsx(ve,{placeholder:"All Time"})}),e.jsxs(ye,{children:[e.jsx(be,{value:"all",children:"All Time"}),e.jsx(be,{value:"today",children:"Today"}),e.jsx(be,{value:"week",children:"Past Week"}),e.jsx(be,{value:"month",children:"Past Month"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[e.jsx(f,{className:"w-4 h-4"}),"Amount Range (AED)"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(pe,{type:"number",placeholder:"Min",value:S.min,onChange:e=>P(s=>({...s,min:e.target.value})),className:"text-sm"}),e.jsx(pe,{type:"number",placeholder:"Max",value:S.max,onChange:e=>P(s=>({...s,max:e.target.value})),className:"text-sm"})]})]})]}),e.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:("all"!==j||"all"!==y||"all"!==w||"all"!==C||S.min||S.max)&&e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Active filters:"}),"all"!==j&&e.jsxs(r,{variant:"secondary",className:"text-xs",children:["Priority: ",j,e.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600",onClick:()=>v("all"),children:"×"})]}),"all"!==y&&e.jsxs(r,{variant:"secondary",className:"text-xs",children:["Project: ",y,e.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600",onClick:()=>b("all"),children:"×"})]}),"all"!==w&&e.jsxs(r,{variant:"secondary",className:"text-xs",children:["Location: ",w,e.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600",onClick:()=>_("all"),children:"×"})]}),"all"!==C&&e.jsxs(r,{variant:"secondary",className:"text-xs",children:["Date: ",C,e.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600",onClick:()=>q("all"),children:"×"})]}),(S.min||S.max)&&e.jsxs(r,{variant:"secondary",className:"text-xs",children:["Amount: AED ",S.min||"0"," - ",S.max||"∞",e.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600",onClick:()=>P({min:"",max:""}),children:"×"})]})]})}),e.jsx(l,{variant:"outline",size:"sm",onClick:()=>{v("all"),b("all"),_("all"),q("all"),P({min:"",max:""}),k("date"),L("desc")},children:"Clear All Filters"})]})]})]}),e.jsx(m,{className:"p-0",children:e.jsxs(me,{value:n,onValueChange:h,children:[e.jsx("div",{className:"border-b px-6 pt-4",children:e.jsxs(xe,{className:"grid grid-cols-5 w-full max-w-4xl",children:[e.jsxs(ue,{value:"pending",children:["Pending (",F.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status||"pending";return"completed"!==s&&"delivered"!==s&&"closed"!==s&&"finished"!==s&&(("pending"===s||"draft"===s)&&!Me.has(e.purchase_id))}).length,")"]}),e.jsxs(ue,{value:"approved",children:["Approved (",F.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;return"completed"!==s&&"delivered"!==s&&"closed"!==s&&"finished"!==s&&(!e.approvals?.action?.some(e=>"accounts"===e.role&&("completed"===e.status||"acknowledged"===e.status))&&("approved"===s||Me.has(e.purchase_id)||"projectManager"===e.status_receiver&&"procurement"===e.status_sender||"accounts"===e.status_receiver&&"completed"!==s||"technicalDirector"===e.status_receiver&&"approved"===s))}).length,")"]}),e.jsxs(ue,{value:"pm_rejected",className:"text-red-600 data-[state=active]:text-red-700 data-[state=active]:border-red-500",children:["PM Reject (",F.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;if("completed"===s||"delivered"===s||"closed"===s||"finished"===s)return!1;const t=e.approvals?.action?.some(e=>"projectManager"===e.role&&"rejected"===e.status),a="projectManager"===e.status_role&&"rejected"===e.sender_latest_status||"projectManager"===e.status_sender&&"rejected"===e.sender_latest_status||"projectManager"===e.status_sender&&"rejected"===e.latest_status;return t||a}).length,")"]}),e.jsxs(ue,{value:"est_rejected",className:"text-blue-600 data-[state=active]:text-blue-700 data-[state=active]:border-blue-500",children:["Est Reject (",F.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;if("completed"===s||"delivered"===s||"closed"===s||"finished"===s)return!1;const t=e.approvals?.action?.some(e=>"estimation"===e.role&&"rejected"===e.status),a="estimation"===e.status_role&&"rejected"===e.sender_latest_status||"estimation"===e.status_sender&&"rejected"===e.sender_latest_status||"estimation"===e.status_sender&&"rejected"===e.latest_status;return t||a}).length,")"]}),e.jsxs(ue,{value:"completed",className:"text-green-600 data-[state=active]:text-green-700 data-[state=active]:border-green-500",children:["Completed (",F.filter(e=>{const s=e.sender_latest_status||e.latest_status||e.status;if("completed"===s||"delivered"===s||"closed"===s||"finished"===s)return!0;if(e.approvals?.action?.some(e=>"accounts"===e.role&&("completed"===e.status||"acknowledged"===e.status)))return!0;const t=e.approvals?.action?.[e.approvals.action.length-1];return!("accounts"!==t?.role||"completed"!==t.status&&!t.comments?.includes("completed"))}).length,")"]})]})}),e.jsxs(he,{value:n,className:"p-6",children:["pm_rejected"===n&&U.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(T,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-900",children:"These purchase requests were rejected by the Project Manager"}),e.jsx("p",{className:"text-xs text-red-700 mt-1",children:"Review the rejection reasons and make necessary revisions. You can resend these to PM after addressing the issues."})]})]})}),"est_rejected"===n&&U.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(T,{className:"w-5 h-5 text-blue-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-900",children:"These purchase requests were rejected by the Estimation team"}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"Review the technical specifications and cost estimates. You can resend these to Estimation after corrections."})]})]})}),"completed"===n&&U.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-green-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-900",children:"These purchase requests have been fully completed"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"These purchases have gone through the entire approval process and have been delivered/closed successfully."})]})]})}),U.length>0?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:U.map(s=>e.jsx(Pe,{purchase:s,onViewDetails:Ge,onViewHistory:Qe,onEdit:Ye,onSendEmail:Ze,onResendToPM:Je,onResendToEst:Je,emailSent:Me.has(s.purchase_id),sendingEmail:Ie.has(s.purchase_id),isLoading:ze.has(s.purchase_id)},s.purchase_id))}):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(g,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-lg font-medium",children:"pm_rejected"===n?"No PM rejected requisitions found":"est_rejected"===n?"No Estimation rejected requisitions found":"completed"===n?"No completed requisitions found":"No purchase requisitions found"}),e.jsx("p",{className:"text-sm mt-1",children:"all"!==j||"all"!==y||"all"!==w||"all"!==C||S.min||S.max?"Try adjusting your filter settings":"pm_rejected"===n?"Purchase requests rejected by PM will appear here for revision":"est_rejected"===n?"Purchase requests rejected by Estimation will appear here for revision":"completed"===n?"Fully completed/delivered purchase requests will appear here":"Waiting for new purchase requisitions to process"})]})]})]})})]}),e.jsx(Ce,{isOpen:ke,onClose:()=>{Ae(!1),Z(null)},purchaseId:Y,mode:ge,activeTab:n}),e.jsx(le,{open:Oe.isOpen,onOpenChange:e=>!e&&He({...Oe,isOpen:!1}),children:e.jsxs(ie,{children:[e.jsxs(ce,{children:[e.jsx(ne,{children:"Send for Approval"}),e.jsx(oe,{children:Oe.message})]}),e.jsxs(de,{children:[e.jsx(l,{variant:"outline",onClick:()=>He({...Oe,isOpen:!1}),children:"Cancel"}),e.jsx(l,{onClick:async()=>{const{purchaseId:e}=Oe;if(e)try{He(e=>({...e,isLoading:!0})),Ve(s=>new Set(s).add(e)),await Se.sendApprovalEmail(e),Le(s=>new Set(s).add(e)),c.success("Purchase request sent to Project Manager for approval"),await Be()}catch(s){c.error(s.message||"Failed to send email")}finally{Ve(s=>{const t=new Set(s);return t.delete(e),t}),He({isOpen:!1,purchaseId:null,message:"",isLoading:!1})}},disabled:Oe.isLoading,style:{backgroundColor:Oe.isLoading?"#64748b":"#243d8a"},onMouseEnter:e=>!Oe.isLoading&&(e.currentTarget.style.backgroundColor="#1a2d66"),onMouseLeave:e=>!Oe.isLoading&&(e.currentTarget.style.backgroundColor="#243d8a"),className:"text-white flex items-center gap-2",children:Oe.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"pulse-wave",size:"sm"}),"Sending..."]}):"Send to PM"})]})]})}),e.jsx(qe,{isOpen:Re,onClose:()=>{Te(!1),Fe(null)},purchase:$e,onSave:()=>{$e&&Le(e=>{const s=new Set(e);return s.delete($e.purchase_id),s}),Te(!1),Fe(null),Be()}})]})};export{ke as default};
