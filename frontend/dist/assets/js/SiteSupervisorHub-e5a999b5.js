import{j as e}from"./radix-ui-34961435.js";import{r as s,u as a}from"./react-vendor-3707ac94.js";import{C as t,a as r,b as l,c as i}from"./card-e62b6216.js";import{a as c,B as n,b as d,t as o,M as m,A as x,u as h}from"./index-12cad093.js";import{I as p}from"./input-dbd0a11e.js";import{T as u,a as g,b as j,c as N}from"./tabs-8d248749.js";import{D as f,a as b,b as y,c as v,d as w}from"./dialog-d443819a.js";import{S as _,a as C,b as S,c as D,d as q}from"./select-767f455e.js";import{C as P}from"./confirmation-dialog-0228c1b8.js";import{m as L,A as k}from"./ui-vendor-42d562f2.js";import{M as E,Q as F,F as A,u as T,g as R,ag as M,E as $,ah as I,V as O,t as U,k as z,i as V,v as B,I as H,b as G,o as X,ak as K,al as Q,U as J,c as W,am as Y,a8 as Z,z as ee,j as se,Y as ae,A as te,aE as re,S as le,T as ie,ao as ce,ap as ne,aq as de,az as oe,l as me,aj as xe,X as he,aw as pe,q as ue,G as ge,aB as je,aF as Ne,r as fe,aA as be,e as ye,aC as ve,N as we,af as _e,at as Ce,R as Se}from"./icons-2fde7931.js";import{f as De,d as qe}from"./utils-8e4480a0.js";import{a as Pe,g as Le,b as ke}from"./dateFormatter-3b370b4b.js";import{u as Ee}from"./forms-337f692b.js";import{D as Fe}from"./date-input-8a4c9816.js";import{L as Ae}from"./label-d100d551.js";import"./auth-f9290e45.js";const Te=s.forwardRef(({purchase:s,onViewDetails:a,onViewHistory:l,onEdit:i,onDelete:d,onSendEmail:o,isLoading:m=!1,isSendingEmail:x=!1},h)=>{const p=e=>{if(!e)return"Unknown";switch(e.toLowerCase()){case"sitesupervisor":return"Site Supervisor";case"procurement":return"Procurement";case"projectmanager":return"Project Manager";case"estimation":return"Estimation";case"technicaldirector":return"Technical Director";case"accounts":return"Accounts";default:return e.charAt(0).toUpperCase()+e.slice(1)}},u=s.latest_status?"completed"===s.latest_status.sender_latest_status?.toLowerCase()||"task completed"===s.latest_status.receiver_latest_status?.toLowerCase()||"completed"===s.latest_status.status?.toLowerCase()?"completed":s.latest_status.status||s.status||"pending":s.status||"pending",g=(()=>{if(s.latest_status){const e=s.latest_status.status,a=s.latest_status.receiver,t=s.latest_status.sender;return"completed"===e||"task completed"===s.latest_status.receiver_latest_status?{stage:"Completed",color:"text-green-600"}:"rejected"===e?{stage:`Rejected by ${p(t)}`,color:"text-red-600"}:"approved"===e?{stage:`With ${p(a)}`,color:"text-blue-600"}:{stage:`Pending with ${p(a)}`,color:"text-yellow-600"}}return{stage:"Not Started",color:"text-gray-600"}})(),j=s.materials&&s.materials.length>0,N=j?s.materials.reduce((e,s)=>e+s.cost*s.quantity,0):0,f=j?s.materials.reduce((e,s)=>e+s.quantity,0):0,b=s.materials?.length||0;return e.jsx(L.div,{ref:h,initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:e.jsx(t,{className:"hover:shadow-lg transition-all duration-200 border-l-4 border-l-red-400/60 bg-gradient-to-r from-red-50/30 to-transparent focus:outline-none focus:ring-0 select-none",children:e.jsxs(r,{className:"p-3",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900",children:["PR #",s.purchase_id]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs(c,{className:`${(e=>{switch(e?.toLowerCase()){case"approved":return"bg-green-50 text-green-700 border-green-100";case"rejected":return"bg-red-50 text-red-700 border-red-100";case"completed":return"bg-emerald-50 text-emerald-700 border-emerald-100";case"pending":return"bg-yellow-50 text-yellow-700 border-yellow-100";case"under_review":return"bg-blue-50 text-blue-700 border-blue-100";default:return"bg-gray-50 text-gray-700 border-gray-100"}})(u)} text-xs flex items-center gap-1 hover:bg-transparent focus:ring-0 focus:outline-none cursor-default`,children:[(s=>{switch(s?.toLowerCase()){case"approved":case"completed":return e.jsx(V,{className:"h-3.5 w-3.5"});case"rejected":return e.jsx(B,{className:"h-3.5 w-3.5"});case"pending":case"under_review":return e.jsx(z,{className:"h-3.5 w-3.5"});default:return null}})(u),u.charAt(0).toUpperCase()+u.slice(1)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:`text-xs font-medium ${g.color}`,children:g.stage}),s.email_sent&&e.jsx(c,{className:"text-xs bg-green-50 text-green-700 border-green-100",children:e.jsx(E,{className:"h-2.5 w-2.5"})})]})]})]}),e.jsx("p",{className:"text-xs text-gray-600 text-left",children:s.purpose})]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(F,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"font-medium text-gray-900",children:s.site_location})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(A,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"font-medium text-gray-900",children:s.project_id})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(T,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date(s.date).toLocaleDateString()})]})]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-2 mb-3",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(R,{className:"h-3.5 w-3.5 text-gray-400 mx-auto mb-1"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[b," items"]})]}),e.jsx("div",{className:"text-center border-l border-gray-200",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["Qty: ",f]})}),e.jsxs("div",{className:"text-center border-l border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(M,{className:"h-3 w-3 text-gray-400"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Total"})]}),e.jsxs("p",{className:"text-sm font-bold text-green-600",children:["AED ",N.toLocaleString()]})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[e.jsxs(n,{size:"sm",variant:"outline",onClick:()=>a(s.purchase_id),disabled:m,className:"flex items-center justify-center gap-1 text-blue-600 hover:text-blue-700 hover:bg-blue-50 h-7 text-xs",children:[e.jsx($,{className:"h-3 w-3"}),"Details"]}),e.jsxs(n,{size:"sm",variant:"outline",onClick:()=>l(s.purchase_id),disabled:m,className:"flex items-center justify-center gap-1 text-red-600 hover:text-red-700 hover:bg-red-50 h-7 text-xs",children:[e.jsx(I,{className:"h-3 w-3"}),"History"]}),!s.email_sent&&e.jsxs(e.Fragment,{children:[i&&"approved"!==s.status&&e.jsxs(n,{size:"sm",variant:"outline",onClick:()=>i(s.purchase_id),disabled:m,className:"flex items-center justify-center gap-1 text-amber-600 hover:text-amber-700 hover:bg-amber-50 h-7 text-xs",children:[e.jsx(O,{className:"h-3 w-3"}),"Edit"]}),d&&"approved"!==s.status&&e.jsxs(n,{size:"sm",variant:"outline",onClick:()=>d(s.purchase_id),disabled:m,className:"flex items-center justify-center gap-1 text-red-600 hover:text-red-700 hover:bg-red-50 h-7 text-xs",children:[e.jsx(U,{className:"h-3 w-3"}),"Delete"]}),o&&e.jsx(n,{size:"sm",variant:"outline",onClick:()=>o(s.purchase_id),disabled:m||x,className:"flex items-center justify-center gap-1 text-green-600 hover:text-green-700 hover:bg-green-50 h-7 text-xs disabled:opacity-50 disabled:cursor-not-allowed",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 border-2 border-green-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"animate-pulse",children:"Sending..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-3 w-3"}),"Send Email"]})})]})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-100",children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["Created ",De(new Date(s.created_at),{addSuffix:!0})," by ",s.requested_by]})})})]})})})});Te.displayName="PurchaseCard";const Re=({isOpen:a,onClose:l,purchaseId:i,mode:h="details"})=>{const[p,_]=s.useState(!1),[C,S]=s.useState(null),[D,q]=s.useState("history"===h?"status":"details"),[P,k]=s.useState(null);s.useEffect(()=>{a&&i?(S(null),_(!0),T(),q("history"===h?"history":"details")):(S(null),_(!1))},[a,i,h]);const T=async()=>{if(i){_(!0);try{try{const e=await d.get(`/purchase/${i}`);e.data&&(void 0!==e.data.success?e.data.success&&(S(e.data.purchase||e.data),k(e.data.latest_status||e.data.status_info),e.data.purchase?.approvals&&S(s=>({...s,approvals:e.data.purchase.approvals}))):(S(e.data),k(e.data.latest_status||e.data.status_info)))}catch(e){const s=await d.get(`/purchase_history/${i}`);if(s.data.success){const e=s.data.purchase||s.data;S(e),k(s.data.latest_status||s.data.status_info||e.latest_status),s.data.approvals?S(e=>({...e,approvals:s.data.approvals})):s.data.purchase?.approvals||s.data.statuses&&S(e=>({...e,approvals:s.data.statuses}))}}q("history"===h?"status":"details")}catch(s){o.error(s.message||"Failed to load purchase data")}finally{_(!1)}}},$=e=>{switch(e?.toLowerCase()){case"approved":return"bg-green-100 text-green-800 border-green-200";case"rejected":return"bg-red-100 text-red-800 border-red-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"in_progress":case"under_review":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},I=s=>{switch(s?.toLowerCase()){case"approved":return e.jsx(V,{className:"h-4 w-4"});case"rejected":return e.jsx(B,{className:"h-4 w-4"});case"pending":case"in_progress":case"under_review":return e.jsx(z,{className:"h-4 w-4"});default:return e.jsx(ee,{className:"h-4 w-4"})}},O=s=>{switch(s.toLowerCase()){case"sitesupervisor":return e.jsx(X,{className:"h-4 w-4"});case"procurement":return e.jsx(R,{className:"h-4 w-4"});case"projectmanager":default:return e.jsx(J,{className:"h-4 w-4"});case"estimation":return e.jsx(ie,{className:"h-4 w-4"});case"technicaldirector":return e.jsx(le,{className:"h-4 w-4"});case"accounts":return e.jsx(M,{className:"h-4 w-4"});case"store":return e.jsx(re,{className:"h-4 w-4"})}},U=e=>{if(!e)return"Unknown";switch(e.toLowerCase()){case"sitesupervisor":return"Site Supervisor";case"projectmanager":return"Project Manager";case"technicaldirector":return"Technical Director";default:return e.charAt(0).toUpperCase()+e.slice(1)}},oe=e=>e?e.split("/").pop()||e:"No file";return a?e.jsx(f,{open:a,onOpenChange:l,children:e.jsxs(b,{className:"max-w-3xl h-[85vh] p-0 flex flex-col overflow-hidden",children:[e.jsx(y,{className:"bg-gradient-to-r from-red-50 to-red-100 px-4 pr-12 py-3 border-b flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-white rounded-lg shadow-sm",children:e.jsx(R,{className:"w-5 h-5 text-red-600"})}),e.jsxs("div",{children:[e.jsxs(v,{className:"text-lg font-bold text-gray-900",children:["Purchase Request #",i]}),e.jsx(w,{className:"text-xs text-gray-600",children:"history"===h?"View approval history and timeline":"View purchase request details"})]})]}),C&&e.jsxs(c,{className:`${$(C.status)} border px-3 py-1 mr-2`,children:[I(C.status),e.jsx("span",{className:"ml-1.5",children:C.status?.toUpperCase()||"PENDING"})]})]})}),p?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(m,{variant:"pulse-wave",size:"lg"})}):C?e.jsxs(u,{value:D,onValueChange:q,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs(g,{className:"grid w-full grid-cols-3 p-1 bg-gray-100",children:[e.jsxs(j,{value:"details",className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4"}),"Details"]}),e.jsxs(j,{value:"materials",className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Materials (",C.materials?.length||0,")"]}),e.jsxs(j,{value:"status",className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"Latest Status"]})]}),e.jsx(N,{value:"details",className:"flex-1 overflow-hidden mt-0 bg-white",children:e.jsx("div",{className:"h-full overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx(t,{className:"border-0 shadow-sm bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsx(r,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium",children:"Total Materials"}),e.jsx("p",{className:"text-xl font-bold text-blue-900 mt-1",children:C.materials?.length||0})]}),e.jsx("div",{className:"p-2 bg-blue-200/30 rounded-lg",children:e.jsx(R,{className:"w-5 h-5 text-blue-700"})})]})})}),e.jsx(t,{className:"border-0 shadow-sm bg-gradient-to-br from-green-50 to-green-100",children:e.jsx(r,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"Total Value"}),e.jsxs("p",{className:"text-2xl font-bold text-green-900 mt-1",children:["AED ",C.materials?.reduce((e,s)=>e+s.quantity*s.cost,0).toLocaleString()||"0"]})]}),e.jsx("div",{className:"p-2 bg-green-200/30 rounded-lg",children:e.jsx(M,{className:"w-5 h-5 text-green-700"})})]})})}),e.jsx(t,{className:"border-0 shadow-sm bg-gradient-to-br from-red-50 to-red-100",children:e.jsx(r,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-red-600 font-medium",children:"Email Status"}),e.jsx("p",{className:"text-base font-bold text-red-900 mt-1",children:C.email_sent?"Sent to Procurement":"Not Sent"})]}),e.jsx("div",{className:"p-2 bg-red-200/30 rounded-lg",children:e.jsx(E,{className:"w-5 h-5 text-red-700"})})]})})})]}),e.jsx(t,{className:"border-0 shadow-sm",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"p-1.5 bg-red-100 rounded-lg",children:e.jsx(H,{className:"w-4 h-4 text-red-600"})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Basic Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(X,{className:"w-4 h-4 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Project ID"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:C.project_id})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(K,{className:"w-4 h-4 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Requested By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:C.requested_by})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(F,{className:"w-4 h-4 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Site Location"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:C.site_location})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(Q,{className:"w-4 h-4 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Request Date"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:new Date(C.date||C.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(J,{className:"w-4 h-4 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Created By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:C.created_by})]})]}),C.last_modified_by&&e.jsxs("div",{className:"flex items-start gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsx(z,{className:"w-4 h-4 text-gray-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wider",children:"Last Modified By"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-0.5",children:C.last_modified_by})]})]})]})]})]})}),e.jsx(t,{className:"border-0 shadow-sm",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"p-1.5 bg-amber-100 rounded-lg",children:e.jsx(W,{className:"w-4 h-4 text-amber-600"})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Purpose"})]}),e.jsx("div",{className:"bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200",children:e.jsx("p",{className:"text-sm text-gray-800 leading-relaxed",children:C.purpose||"No purpose specified"})})]})}),e.jsx(t,{className:"border-0 shadow-sm",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"p-1.5 bg-purple-100 rounded-lg",children:e.jsx(Y,{className:"w-4 h-4 text-purple-600"})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Document Attachments"})]}),C.file_path?e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[(s=>{if(!s)return e.jsx(ce,{className:"h-5 w-5 text-gray-400"});const a=s.split(".").pop()?.toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(a||"")?e.jsx(ne,{className:"h-5 w-5 text-blue-500"}):["xls","xlsx","csv"].includes(a||"")?e.jsx(de,{className:"h-5 w-5 text-green-500"}):["pdf"].includes(a||"")?e.jsx(A,{className:"h-5 w-5 text-red-500"}):e.jsx(ce,{className:"h-5 w-5 text-gray-400"})})(C.file_path),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:oe(C.file_path)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Uploaded by ",C.requested_by||"Site Supervisor"]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(n,{variant:"outline",size:"sm",className:"flex items-center gap-2",onClick:()=>(async e=>{if(e&&i)try{const s=await fetch(`${x}/download_files?key=siteSupervisor&id=${i}`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(!s.ok)throw new Error(`HTTP ${s.status}: Failed to get download URL`);const a=await s.json();let t=null;if(a.purchase_files&&a.purchase_files.length>0?t=a.purchase_files[0].public_url:a.accounts_files&&a.accounts_files.length>0&&(t=a.accounts_files[0].public_url),t){const s=document.createElement("a");s.href=t,s.download=oe(e),s.target="_blank",document.body.appendChild(s),s.click(),document.body.removeChild(s),o.success("Download started")}else o.error("No file available for download")}catch(s){o.error(`Failed to download file: ${s instanceof Error?s.message:"Unknown error"}`)}})(C.file_path),children:[e.jsx(Z,{className:"h-3.5 w-3.5"}),"Download"]})})]}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1 mt-3",children:[e.jsx(ee,{className:"h-3 w-3"}),"Files are securely stored and can be accessed by authorized personnel only"]})]}):e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 text-center",children:[e.jsx(Y,{className:"h-8 w-8 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No attachments uploaded"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Documents can be attached when creating purchase requests"})]})]})})]})})}),e.jsx(N,{value:"materials",className:"flex-1 overflow-hidden mt-0 bg-white",children:e.jsx("div",{className:"h-full overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:C.materials&&C.materials.length>0?e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-4",children:[C.materials.map((s,a)=>e.jsx(L.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*a},children:e.jsx(t,{className:"border-0 shadow-sm hover:shadow-md transition-all",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-purple-100 rounded-lg",children:e.jsx(se,{className:"w-4 h-4 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base",children:s.description}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Item #",a+1]})]})]}),e.jsx(c,{className:"bg-purple-100 text-purple-700 border-purple-200",children:s.category})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded-lg",children:[e.jsx("p",{className:"text-xs text-gray-500 font-medium uppercase",children:"Specification"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 mt-1",children:s.specification||"N/A"})]}),e.jsxs("div",{className:"bg-blue-50 p-2 rounded-lg",children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium uppercase",children:"Quantity"}),e.jsxs("p",{className:"text-sm font-semibold text-blue-900 mt-1",children:[s.quantity," ",s.unit]})]}),e.jsxs("div",{className:"bg-green-50 p-2 rounded-lg",children:[e.jsx("p",{className:"text-xs text-green-600 font-medium uppercase",children:"Unit Cost"}),e.jsxs("p",{className:"text-sm font-semibold text-green-900 mt-1",children:["AED ",s.cost.toLocaleString()]})]}),e.jsxs("div",{className:"bg-amber-50 p-2 rounded-lg",children:[e.jsx("p",{className:"text-xs text-amber-600 font-medium uppercase",children:"Total Cost"}),e.jsxs("p",{className:"text-sm font-semibold text-amber-900 mt-1",children:["AED ",(s.quantity*s.cost).toLocaleString()]})]})]}),(s.priority||s.design_reference)&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-4",children:[s.priority&&e.jsxs(c,{className:"bg-amber-100 text-amber-700 border-amber-200",children:["Priority: ",s.priority]}),s.design_reference&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Design Ref: ",s.design_reference]})]})})]})})},s.material_id)),e.jsx(t,{className:"border-2 border-green-200 bg-gradient-to-r from-green-50 to-emerald-50",children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-100 rounded-lg",children:e.jsx(M,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Purchase Value"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:["AED ",C.materials.reduce((e,s)=>e+s.quantity*s.cost,0).toLocaleString()]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[C.materials.length," Materials"]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[C.materials.reduce((e,s)=>e+s.quantity,0)," Total Units"]})]})]})})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(R,{className:"h-16 w-16 text-gray-300 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-600",children:"No Materials Found"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"No materials have been added to this purchase request"})]})})}),e.jsx(N,{value:"status",className:"flex-1 overflow-hidden mt-0 bg-white",children:e.jsx("div",{className:"h-full overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:P||C&&(C.approvals?.length>0||C.latest_status||C.status_info)?e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-4",children:[e.jsx(t,{className:"border-0 shadow-sm",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"p-1.5 bg-blue-100 rounded-lg",children:e.jsx(G,{className:"w-4 h-4 text-blue-600"})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Current Status"})]}),(()=>{const s=C.approvals?.length>0?C.approvals[C.approvals.length-1]:C.latest_status||C.status_info||{};return e.jsxs("div",{className:"p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(c,{className:`${$(s.status)} border text-sm py-1 px-2`,children:[I(s.status),e.jsx("span",{className:"ml-1",children:s.status?.toUpperCase()||"PENDING"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:["by ",U(s.role)]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.decision_date&&Pe(s.decision_date)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Status ID"}),e.jsxs("p",{className:"font-mono text-sm font-semibold text-gray-700",children:["#",s.status_id]})]})]}),"rejected"===s.status&&s.rejection_reason&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-100",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-red-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-red-600 font-medium",children:"Rejection Reason"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:s.rejection_reason})]})]})}),s.comments&&e.jsx("div",{className:"mt-3 p-2 bg-blue-50 rounded border border-blue-100",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(H,{className:"w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium",children:"Comments"}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1 italic",children:['"',s.comments,'"']})]})]})})]})})()]})}),C.approvals&&C.approvals.length>0&&e.jsx(t,{className:"border-0 shadow-sm",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"p-1.5 bg-green-100 rounded-lg",children:e.jsx(ae,{className:"w-4 h-4 text-green-600"})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Complete Approval Timeline"}),e.jsxs(c,{className:"bg-gray-100 text-gray-600 text-xs ml-auto",children:[C.approvals.length," Steps"]})]}),e.jsx("div",{className:"space-y-3",children:C.approvals.map((s,a)=>e.jsxs(L.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1*a},className:"relative",children:[a<C.approvals.length-1&&e.jsx("div",{className:"absolute left-6 top-12 bottom-0 w-0.5 bg-gray-200"}),e.jsxs("div",{className:"flex gap-3 p-3 rounded-lg border-l-4 "+("approved"===s.status?"bg-green-50 border-l-green-400":"rejected"===s.status?"bg-red-50 border-l-red-400":"bg-yellow-50 border-l-yellow-400"),children:[e.jsx("div",{className:"p-2 rounded-full "+("approved"===s.status?"bg-green-100":"rejected"===s.status?"bg-red-100":"bg-yellow-100"),children:O(s.role)}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:U(s.role)}),e.jsxs(c,{className:`${$(s.status)} text-xs`,children:[I(s.status),e.jsx("span",{className:"ml-1",children:s.status.charAt(0).toUpperCase()+s.status.slice(1)})]})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[s.created_by," â€¢ ",Pe(s.decision_date)]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-xs text-gray-400",children:["Step ",a+1]}),e.jsxs("p",{className:"text-xs text-gray-400",children:["ID: #",s.status_id]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-xs text-gray-500",children:[e.jsx("span",{children:U(s.sender)}),e.jsx(te,{className:"w-3 h-3"}),e.jsx("span",{children:U(s.receiver)})]}),s.comments&&e.jsx("div",{className:"mt-2 p-2 bg-white/60 rounded border",children:e.jsxs("p",{className:"text-xs text-gray-600 italic",children:['"',s.comments,'"']})}),"rejected"===s.status&&s.rejection_reason&&e.jsxs("div",{className:"mt-2 p-2 bg-red-100/60 rounded border border-red-200",children:[e.jsx("p",{className:"text-xs text-red-600 font-medium",children:"Rejection Reason:"}),e.jsx("p",{className:"text-xs text-red-700 mt-1",children:s.rejection_reason})]})]})]})]},s.status_id))})]})}),C.approvals&&C.approvals.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx(t,{className:"border-0 shadow-sm bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsx(r,{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium",children:"Total Steps"}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:C.approvals.length})]})]})})}),e.jsx(t,{className:"border-0 shadow-sm bg-gradient-to-br from-green-50 to-green-100",children:e.jsx(r,{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"Approved"}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:C.approvals.filter(e=>"approved"===e.status).length})]})]})})}),e.jsx(t,{className:"border-0 shadow-sm bg-gradient-to-br from-red-50 to-red-100",children:e.jsx(r,{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-red-600 font-medium",children:"Rejected"}),e.jsx("p",{className:"text-lg font-bold text-red-900",children:C.approvals.filter(e=>"rejected"===e.status).length})]})]})})})]}),!C.approvals?.length&&(P||C.latest_status||C.status)&&e.jsx(t,{className:"border-0 shadow-sm",children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"p-1.5 bg-purple-100 rounded-lg",children:e.jsx(H,{className:"w-4 h-4 text-purple-600"})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Status Information"})]}),e.jsx("div",{className:"space-y-2",children:(()=>{const s=P||C.latest_status||{};return e.jsxs(e.Fragment,{children:[(s.status||C.status)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Status:"}),e.jsx(c,{className:`${$(s.status||C.status)} border`,children:(s.status||C.status||"PENDING").toUpperCase()})]}),s.role&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Role:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:U(s.role)})]}),s.sender&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"From:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:U(s.sender)})]}),s.receiver&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"To:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:U(s.receiver)})]}),s.comments&&e.jsx("div",{className:"mt-2 p-2 bg-gray-50 rounded",children:e.jsx("p",{className:"text-sm text-gray-700",children:s.comments})}),C.purpose&&!s.comments&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 rounded",children:[e.jsx("p",{className:"text-xs text-gray-600 font-medium",children:"Purpose:"}),e.jsx("p",{className:"text-sm text-gray-700",children:C.purpose})]})]})})()})]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(G,{className:"h-16 w-16 text-gray-300 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-600",children:"No Status Information"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Status information will appear once the request is processed"})]})})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("p",{className:"text-gray-500",children:"No purchase data available"})})]})}):null};const Me=new class{async getPurchases(){try{const e=await d.get("/all_purchase");if(e.data.success)return e.data.purchase_requests||[];throw new Error(e.data.message||"Failed to fetch purchases")}catch(e){throw e}}async getPurchaseDetails(e){try{const s=await d.get(`/purchase_history/${e}`);if(s.data.success)return s.data.purchase;throw new Error(s.data.message||"Failed to fetch purchase details")}catch(s){throw s}}async getPurchaseHistory(e){try{const s=await d.get(`/purchase_history/${e}`);if(s.data.success)return{purchase:s.data.purchase};throw new Error(s.data.message||"Failed to fetch purchase history")}catch(s){throw s}}async createPurchase(e){try{const s=await d.post("/purchase",e);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to create purchase")}catch(s){throw s}}async updatePurchase(e,s){try{const a=await d.put(`/purchase/${e}`,s);if(a.data.success)return a.data;throw new Error(a.data.message||"Failed to update purchase")}catch(a){throw a}}async deletePurchase(e){try{const s=await d.delete(`/purchase/${e}`);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to delete purchase")}catch(s){throw s}}async sendPurchaseEmail(e){try{const s=await d.get(`/purchase_email/${e}`);if(s.data.success)return s.data;throw new Error(s.data.message||"Failed to send email")}catch(s){throw s}}async uploadFile(e,s){try{const a=new FormData;a.append("file",s);const t=await d.post(`/upload_file?key=siteSupervisor&id=${e}`,a,{headers:{"Content-Type":"multipart/form-data"}});if(t.data.success)return t.data;throw new Error(t.data.message||"Failed to upload file")}catch(a){throw a}}async getDashboardData(){try{const e=await d.get("/site_supervisor_dashboard");if(e.data.success)return e.data.dashboard_data;throw new Error(e.data.message||"Failed to fetch dashboard data")}catch(e){throw e}}},$e=({isOpen:a,onClose:l,purchaseId:i})=>{const[n,d]=s.useState(!1),[x,h]=s.useState(null);s.useEffect(()=>{a&&i?p():h(null)},[a,i]);const p=async()=>{if(i){d(!0);try{const e=await Me.getPurchaseHistory(i);h(e.purchase)}catch(e){o.error(e.message||"Failed to load purchase history")}finally{d(!1)}}},u=e=>{switch(e?.toLowerCase()){case"approved":case"completed":case"complete":return"bg-green-100 text-green-800 border-green-200";case"rejected":return"bg-red-100 text-red-800 border-red-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},g=s=>{switch(s?.toLowerCase()){case"approved":case"completed":case"complete":return e.jsx(V,{className:"h-4 w-4"});case"rejected":return e.jsx(B,{className:"h-4 w-4"});case"pending":return e.jsx(z,{className:"h-4 w-4"});default:return e.jsx(ee,{className:"h-4 w-4"})}},j=s=>{switch(s.toLowerCase()){case"sitesupervisor":return e.jsx(X,{className:"h-4 w-4"});case"procurement":return e.jsx(R,{className:"h-4 w-4"});case"projectmanager":default:return e.jsx(J,{className:"h-4 w-4"});case"estimation":return e.jsx(ie,{className:"h-4 w-4"});case"technicaldirector":return e.jsx(me,{className:"h-4 w-4"});case"accounts":return e.jsx(M,{className:"h-4 w-4"})}},N=e=>{if(!e)return"Unknown";switch(e.toLowerCase()){case"sitesupervisor":return"Site Supervisor";case"projectmanager":return"Project Manager";case"technicaldirector":return"Technical Director";default:return e.charAt(0).toUpperCase()+e.slice(1)}},_=e=>{switch(e.toLowerCase()){case"sitesupervisor":return"border-l-red-400";case"procurement":return"border-l-blue-400";case"projectmanager":return"border-l-green-400";case"estimation":return"border-l-purple-400";case"technicaldirector":return"border-l-orange-400";case"accounts":return"border-l-yellow-400";default:return"border-l-gray-400"}};return a?e.jsx(f,{open:a,onOpenChange:l,children:e.jsxs(b,{className:"max-w-5xl h-[90vh] p-0 flex flex-col overflow-hidden",children:[e.jsx(y,{className:"bg-gradient-to-r from-blue-50 to-indigo-100 px-6 py-4 border-b flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-white rounded-lg shadow-sm",children:e.jsx(I,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(v,{className:"text-xl font-bold text-gray-900",children:"Purchase Request History"}),e.jsxs(w,{className:"text-sm text-gray-600 mt-1",children:["PR #",i," - Complete approval timeline and workflow history"]})]})]})}),n?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(m,{variant:"pulse-wave",size:"lg"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Loading purchase history..."})]})}):x?e.jsx("div",{className:"flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(t,{className:"border-0 shadow-lg bg-gradient-to-r from-gray-50 to-blue-50",children:e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(R,{className:"h-5 w-5 text-blue-600"}),"Purchase Details"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Purpose:"})," ",e.jsx("span",{className:"text-gray-900",children:x.purpose})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Location:"})," ",e.jsx("span",{className:"text-gray-900",children:x.site_location})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Project:"})," ",e.jsxs("span",{className:"text-gray-900",children:["#",x.project_id]})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5 text-green-600"}),"Request Info"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Requested by:"})," ",e.jsx("span",{className:"text-gray-900",children:x.requested_by})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Date:"})," ",e.jsx("span",{className:"text-gray-900",children:qe(new Date(x.date),"MMM dd, yyyy")})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5 text-purple-600"}),"Timeline Stats"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Total Steps:"})," ",e.jsx("span",{className:"text-gray-900 font-semibold",children:x.approvals?.action?.length||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Approvals:"})," ",e.jsx("span",{className:"text-green-600 font-semibold",children:x.approvals?.action?.filter(e=>"approved"===e.status).length||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Rejections:"})," ",e.jsx("span",{className:"text-red-600 font-semibold",children:x.approvals?.action?.filter(e=>"rejected"===e.status).length||0})]})]})]})]})})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mb-6 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(G,{className:"h-6 w-6 text-blue-600"})}),"Approval Timeline",e.jsxs(c,{className:"bg-blue-100 text-blue-800",children:[x.approvals?.action?.length||0," Steps"]})]}),x.approvals?.action&&x.approvals.action.length>0?e.jsx("div",{className:"space-y-4",children:x.approvals.action.sort((e,s)=>new Date(e.timestamp).getTime()-new Date(s.timestamp).getTime()).map((s,a)=>e.jsxs(L.div,{initial:{opacity:0,x:-30},animate:{opacity:1,x:0},transition:{delay:.1*a},className:"relative",children:[a<x.approvals.action.length-1&&e.jsx("div",{className:"absolute left-6 top-16 w-0.5 h-16 bg-gray-200 z-0"}),e.jsx(t,{className:`border-l-4 ${_(s.role)} hover:shadow-lg transition-all duration-300 relative z-10`,children:e.jsxs(r,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:j(s.role)}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-lg",children:N(s.role)}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:s.decided_by}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Step #",a+1]})]})]}),e.jsxs(c,{className:`${u(s.status)} border text-sm py-1 px-3`,children:[g(s.status),e.jsx("span",{className:"ml-2 font-semibold",children:s.status.toUpperCase()})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg border",children:e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 font-semibold text-gray-700",children:[j(s.sender),N(s.sender)]}),e.jsx(te,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2 font-semibold text-gray-700",children:[j(s.receiver),N(s.receiver)]}),s.comments.includes("Email sent")&&e.jsxs("div",{className:"flex items-center gap-1 text-blue-600 ml-auto",children:[e.jsx(E,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Email Sent"})]})]})}),s.comments&&e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(oe,{className:"h-5 w-5 text-amber-500 mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"bg-amber-50 p-4 rounded-lg border border-amber-200 flex-1",children:e.jsxs("p",{className:"text-sm text-amber-900 italic leading-relaxed",children:['"',s.comments,'"']})})]})}),s.rejection_reason&&e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"bg-red-50 p-4 rounded-lg border border-red-200",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(B,{className:"h-5 w-5 text-red-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-red-800 mb-1",children:"Rejection Reason:"}),e.jsx("p",{className:"text-sm text-red-700 leading-relaxed",children:s.rejection_reason}),s.reject_category&&e.jsxs(c,{className:"mt-2 bg-red-100 text-red-800 border-red-200",children:["Category: ",s.reject_category.toUpperCase()]})]})]})})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 pt-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{className:"h-3 w-3"}),e.jsxs("span",{children:["Action Time: ",qe(new Date(s.timestamp),"MMM dd, yyyy HH:mm:ss")]})]}),s.type&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3 w-3"}),e.jsxs("span",{children:["Type: ",s.type.replace(/_/g," ")]})]})]})]})})]},`${a}-${s.timestamp}`))}):e.jsxs(t,{className:"p-12 text-center border-dashed border-2",children:[e.jsx(I,{className:"h-16 w-16 mx-auto text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-600 mb-2",children:"No History Available"}),e.jsx("p",{className:"text-sm text-gray-500",children:"This purchase request doesn't have any approval history yet."})]})]})]})}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ee,{className:"h-16 w-16 mx-auto text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-600 mb-2",children:"No Data Available"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Unable to load purchase history."})]})})]})}):null},Ie=({onClose:a,showAsPage:t,existingData:r,isEditMode:l,editMode:i,purchaseData:m})=>{const{register:x,handleSubmit:u,watch:g,formState:{errors:j},setValue:N,getValues:P}=Ee(),{user:E}=h(),F=E?.full_name||E?.name||"Site Supervisor",M=E?.role||"Site Supervisor",[$,I]=s.useState([]),[O,V]=s.useState([]),[B,H]=s.useState("details");s.useState(!1);const[G,X]=s.useState(null),[K,Q]=s.useState(!1),[W,Z]=s.useState(!1),[ee,ae]=s.useState(""),[te,re]=s.useState(!1),[le,ce]=s.useState(!1),[ne,de]=s.useState(!1);s.useEffect(()=>{try{N("requested_by",F);const e=l||i,s=m||r;if(e||s||N("date",Le()),e&&s){const e=s.originalData||s;if(!e)return void o.error("No data available for editing");const a=e.project_id||s.project_id;a&&(X(a),N("project_id",a)),N("site_location",e.site_location||""),N("requested_by",F);const t=e.date||s.date;N("date",t?ke(t):Le()),N("purpose",e.purpose||""),N("justification",e.justification||e.purpose||"");const l=e.materials||s.materials||[];if(e.design_reference?(ae(e.design_reference),N("designReferences",[e.design_reference])):e.design_references?(ae(e.design_references.join(", ")),N("designReferences",e.design_references)):l&&l.length>0&&l[0].design_reference&&ae(l[0].design_reference),l.length>0){const e=l.map((e,s)=>({id:`material_${e.material_id||s}_${Date.now()}`,material_id:e.material_id,description:e.description||e.item_name||"",specification:e.specification||"",unit:e.unit||"pcs",quantity:e.quantity||1,cost:e.cost||0,priority:e.priority||"Medium",category:e.category||"General",design_reference:e.design_reference||""}));I(e);const s=e.reduce((e,s)=>e+s.quantity*s.cost,0);N("totalEstimatedCost",s)}else r&&r.items&&r.items>0&&r.id&&oe(r.id).catch(e=>{});e&&e.approvals&&N("approvalFlags",{qtySpec:e.approvals.qtySpec||!1,cost:e.approvals.cost||!1}),e&&N("status",e.status||"draft"),e&&e.site_location&&e.requested_by&&Q(!0),l&&l.length>0&&Z(!0)}}catch(e){o.error("Failed to load form data. Please try again.")}},[l,i,r,m,N,F]);const oe=async e=>{try{const s=await d.get(`/purchase/${e}`);if(s.data.success){const e=s.data.purchase.materials||[];e.length>0&&I(e.map(e=>({id:Date.now().toString()+Math.random(),description:e.description||e.item_name||"",specification:e.specification||"",unit:e.unit||"pcs",quantity:e.quantity||1,cost:e.cost||0,priority:e.priority||"Medium",category:e.category||"General",design_reference:e.design_reference||""})))}}catch(s){o.error("Failed to load materials")}},me=(e,s,a)=>{I($.map(t=>t.id===e?{...t,[s]:a}:t))},ye=()=>$.reduce((e,s)=>e+s.quantity*s.cost,0),ve=()=>{const e=P(),s=g("date");return G&&e.site_location&&e.requested_by&&(e.date||s)&&e.purpose},we=()=>$.length>0&&$.every(e=>e.description&&e.specification&&e.quantity>0&&e.category),_e=e=>{"materials"!==e||ve()?"attachments"!==e||we()?H(e):o.error("Please add at least one material with complete information"):o.error("Please fill all required fields in Details tab first")},Ce=e=>{try{if(!e){return(new Date).toISOString().split("T")[0]}if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;const s=e.split("/");if(3===s.length){const[e,a,t]=s;return`${t}-${a.padStart(2,"0")}-${e.padStart(2,"0")}`}return e.includes("T")?e.split("T")[0]:e}catch(s){return(new Date).toISOString().split("T")[0]}},Se=async e=>{if(le)return;if(!G)return void o.error("Please select a project");if(!we())return void o.error("Please complete all material information");ce(!0),re(!0);const s=P(),t=g("date")||s.date||Le(),c=g("site_location")||s.site_location||"",n=g("purpose")||s.purpose||"",x={project_id:G,site_location:c,requested_by:F,date:Ce(t),purpose:n,design_reference:ee||"",materials:$.map(e=>({description:e.description,specification:e.specification,unit:e.unit,quantity:e.quantity,category:e.category,cost:e.cost,priority:e.priority,design_reference:ee||e.design_reference||""}))};try{let e,s;const p=m||r,u=p?.purchase_id||p?.id;if((l||i)&&u){const a={requested_by:F,site_location:c,date:Ce(t),project_id:G,purpose:n,file_path:p?.originalData?.file_path||p?.file_path||"",materials:$.map(e=>{const s={project_id:G,description:e.description,specification:e.specification,unit:e.unit,quantity:e.quantity,category:e.category,cost:e.cost,priority:e.priority,design_reference:e.design_reference||ee||""};return e.material_id&&(s.material_id=e.material_id),s})};e=await d.put(`/purchase/${u}`,a),s=u}else e=await d.post("/purchase",x),s=e.data.purchase_id;if(!e.data.success&&e.data.error)return o.error(e.data.error||"Failed to save purchase request"),void re(!1);if(O.length>0&&s)for(const a of O){const e=new FormData;e.append("file",a);try{await d.post(`/upload_file?key=siteSupervisor&id=${s}`,e,{headers:{"Content-Type":"multipart/form-data"}})}catch(h){o.warning(`File ${a.name} could not be uploaded. Purchase requisition was ${l?"updated":"created"} successfully.`)}}o.success(l?"Purchase Requisition updated successfully!":"Purchase Requisition submitted successfully!"),l||(I([]),V([]),X(null),ae(""),H("details"),N("site_location",""),N("purpose",""),N("date","")),Q(!1),Z(!1),a&&a()}catch(p){const e=p.response?.data?.error||p.response?.data?.message||p.message||`Failed to ${l?"update":"submit"} purchase requisition`;o.error(e)}finally{re(!1),ce(!1)}},De={Low:"bg-slate-100 text-slate-700 border-slate-300",Medium:"bg-red-100 text-red-700 border-red-300",High:"bg-amber-100 text-amber-700 border-amber-300",Urgent:"bg-red-100 text-red-700 border-red-300"};return e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center",children:e.jsx(R,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:l?"Edit Purchase Request":"New Purchase Request"}),e.jsx("p",{className:"text-sm text-gray-500",children:l?"Update request details":"Create and submit material purchase requests"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(c,{variant:"secondary",className:"bg-red-50 text-red-700 border-red-200",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),"PR-2024-001"]}),e.jsxs(c,{variant:"secondary",className:"bg-green-50 text-green-700 border-green-200",children:[e.jsx(z,{className:"w-3 h-3 mr-1"}),"Draft"]}),a&&e.jsx(n,{type:"button",variant:"ghost",size:"sm",onClick:a,className:"text-gray-500 hover:text-gray-700",children:e.jsx(he,{className:"w-4 h-4"})})]})]})}),e.jsx("div",{className:"bg-white border-b border-gray-200",children:e.jsx("div",{className:"px-6",children:e.jsxs("div",{className:"flex space-x-8",children:[e.jsxs("button",{type:"button",onClick:()=>_e("details"),className:"py-4 px-1 border-b-2 font-medium text-sm "+("details"===B?"border-red-500 text-red-600":"border-transparent text-gray-500 hover:text-gray-700"),children:[e.jsx(A,{className:"w-4 h-4 mr-2 inline"}),"Details"]}),e.jsxs("button",{type:"button",onClick:()=>_e("materials"),className:"py-4 px-1 border-b-2 font-medium text-sm "+("materials"===B?"border-red-500 text-red-600":"border-transparent text-gray-500 hover:text-gray-700"),children:[e.jsx(R,{className:"w-4 h-4 mr-2 inline"}),"Materials"]}),e.jsxs("button",{type:"button",onClick:()=>_e("attachments"),className:"py-4 px-1 border-b-2 font-medium text-sm "+("attachments"===B?"border-red-500 text-red-600":"border-transparent text-gray-500 hover:text-gray-700"),children:[e.jsx(Y,{className:"w-4 h-4 mr-2 inline"}),"Attachments"]})]})})}),e.jsxs("form",{onSubmit:u(Se),className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"p-6 space-y-8",children:["details"===B&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-100",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-red-600"}),"Project & Requester Information"]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-sm font-medium text-gray-700",children:"Project Name"}),e.jsxs(_,{value:G?.toString(),onValueChange:e=>{const s=parseInt(e);X(s),N("project_id",s)},children:[e.jsx(C,{className:"h-11 border-gray-300 focus:border-red-500 focus:ring-red-500",children:e.jsx(S,{placeholder:"Select project"})}),e.jsxs(D,{children:[e.jsx(q,{value:"1",children:"Project Alpha"}),e.jsx(q,{value:"2",children:"Project Beta"}),e.jsx(q,{value:"3",children:"Project Gamma"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-sm font-medium text-gray-700",children:"Site Location"}),e.jsx(p,{...x("site_location",{required:!0}),placeholder:"Enter site location (e.g., Erode)",className:"h-11 border-gray-300 focus:border-red-500 focus:ring-red-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Ae,{className:"flex items-center gap-2 text-sm font-semibold",children:[e.jsx(J,{className:"w-4 h-4 text-gray-500"}),"Requested By"]}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{...x("requested_by"),value:F,readOnly:!0,className:"h-11 bg-gray-50 border-gray-200 cursor-not-allowed pr-20"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:M})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Ae,{className:"flex items-center gap-2 text-sm font-semibold",children:[e.jsx(T,{className:"w-4 h-4 text-gray-500"}),"Date Required"]}),e.jsx(Fe,{value:g("date")||Le(),onChange:e=>N("date",e),className:"h-11 border-gray-200 focus:border-red-500",placeholder:"dd/mm/yyyy",min:(new Date).toISOString().split("T")[0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-sm font-medium text-gray-700",children:"Justification / Purpose"}),e.jsx("textarea",{...x("purpose",{required:!0}),className:"w-full min-h-[100px] p-3 border border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500",placeholder:"Explain the purpose and urgency of this requisition (e.g., Foundation materials)..."})]})]})]}),"materials"===B&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5 text-red-600"}),"Material Requirements"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(c,{variant:"secondary",className:"bg-red-50 text-red-700 border-red-200",children:[$.length," Items"]}),e.jsxs(c,{variant:"secondary",className:"bg-green-50 text-green-700 border-green-200",children:[e.jsx(ue,{className:"w-3 h-3 mr-1"}),"Total: AED ",ye().toLocaleString()]})]})]})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{children:$.map((s,a)=>e.jsxs(L.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},className:"bg-gray-50 rounded-xl p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center text-red-600 font-semibold text-sm",children:a+1}),e.jsxs(c,{className:`${De[s.priority]} border`,children:[e.jsx(ie,{className:"w-3 h-3 mr-1"}),s.priority]})]}),e.jsx(n,{type:"button",variant:"ghost",size:"sm",onClick:()=>{return e=s.id,void I($.filter(s=>s.id!==e));var e},className:"text-red-500 hover:text-red-700 hover:bg-red-50",children:e.jsx(U,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Description"}),e.jsx(p,{value:s.description,onChange:e=>me(s.id,"description",e.target.value),placeholder:"Material description",className:"border-gray-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Category"}),e.jsxs(_,{value:s.category,onValueChange:e=>me(s.id,"category",e),children:[e.jsx(C,{className:"border-gray-200",children:e.jsx(S,{placeholder:"Select category"})}),e.jsxs(D,{children:[e.jsx(q,{value:"Structural",children:"Structural"}),e.jsx(q,{value:"Building Material",children:"Building Material"}),e.jsx(q,{value:"Hardware",children:"Hardware"}),e.jsx(q,{value:"Electrical",children:"Electrical"}),e.jsx(q,{value:"Plumbing",children:"Plumbing"}),e.jsx(q,{value:"Furniture",children:"Furniture"}),e.jsx(q,{value:"Finishes",children:"Finishes"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Specification"}),e.jsx(p,{value:s.specification,onChange:e=>me(s.id,"specification",e.target.value),placeholder:"Specs/Model",className:"border-gray-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Unit"}),e.jsxs(_,{value:s.unit,onValueChange:e=>me(s.id,"unit",e),children:[e.jsx(C,{className:"border-gray-200",children:e.jsx(S,{})}),e.jsxs(D,{children:[e.jsx(q,{value:"pcs",children:"Pieces"}),e.jsx(q,{value:"kg",children:"Kilogram"}),e.jsx(q,{value:"bag",children:"Bag"}),e.jsx(q,{value:"m",children:"Meter"}),e.jsx(q,{value:"sqm",children:"Sq. Meter"}),e.jsx(q,{value:"box",children:"Box"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Quantity"}),e.jsx(p,{type:"number",value:s.quantity,onChange:e=>me(s.id,"quantity",parseFloat(e.target.value)),className:"border-gray-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Est. Unit Cost"}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(p,{type:"number",value:s.cost,onChange:e=>me(s.id,"cost",parseFloat(e.target.value)),className:"pl-9 border-gray-200"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Design Reference"}),e.jsx(p,{value:s.design_reference,onChange:e=>me(s.id,"design_reference",e.target.value),placeholder:"Drawing/Design reference (e.g., DR-001)",className:"border-gray-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"text-xs font-semibold text-gray-600",children:"Priority"}),e.jsxs(_,{value:s.priority,onValueChange:e=>me(s.id,"priority",e),children:[e.jsx(C,{className:"border-gray-200",children:e.jsx(S,{})}),e.jsxs(D,{children:[e.jsx(q,{value:"Low",children:"Low Priority"}),e.jsx(q,{value:"Medium",children:"Medium Priority"}),e.jsx(q,{value:"High",children:"High Priority"}),e.jsx(q,{value:"Urgent",children:"Urgent"})]})]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Subtotal:"}),e.jsxs("span",{className:"font-semibold text-lg text-red-600",children:["AED ",(s.quantity*s.cost).toLocaleString()]})]})})]},s.id))}),e.jsxs(n,{type:"button",onClick:()=>{const e={id:Date.now().toString(),description:"",specification:"",unit:"pcs",quantity:1,cost:0,priority:"Medium",category:"",design_reference:""};I([...$,e])},className:"w-full bg-red-600 hover:bg-red-700 text-white",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"Add Material Item"]}),$.length>0&&e.jsx("div",{className:"bg-gradient-to-r from-red-50 to-red-100 rounded-xl p-6 border border-red-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"w-6 h-6 text-red-600"}),e.jsx("span",{className:"text-lg font-semibold text-gray-800",children:"Total Estimated Cost:"})]}),e.jsxs("span",{className:"text-2xl font-bold text-red-600",children:["AED ",ye().toLocaleString()]})]})})]})})]}),"attachments"===B&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-100",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5 text-red-600"}),"Documents & References"]})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-red-400 transition-colors cursor-pointer",onClick:()=>document.getElementById("file-upload")?.click(),onDragOver:e=>{e.preventDefault(),e.currentTarget.classList.add("border-red-400","bg-red-50")},onDragLeave:e=>{e.preventDefault(),e.currentTarget.classList.remove("border-red-400","bg-red-50")},onDrop:e=>{e.preventDefault(),e.currentTarget.classList.remove("border-red-400","bg-red-50");const s=Array.from(e.dataTransfer.files).filter(e=>{if(e.size>10485760)return o.error(`File ${e.name} is too large. Maximum size is 10MB.`),!1;return!!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/png","image/jpeg","image/jpg"].includes(e.type)||(o.error(`File ${e.name} has invalid format.`),!1)});V([...O,...s])},children:[e.jsx(Ne,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-2",children:"Drop files here or click to upload"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:"Supported formats: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG (Max 10MB)"}),e.jsx(p,{type:"file",multiple:!0,onChange:e=>{if(e.target.files){const s=Array.from(e.target.files).filter(e=>{if(e.size>10485760)return o.error(`File ${e.name} is too large. Maximum size is 10MB.`),!1;return!!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/png","image/jpeg","image/jpg"].includes(e.type)||(o.error(`File ${e.name} has invalid format. Supported formats: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG`),!1)});V([...O,...s]),e.target.value=""}},className:"hidden",id:"file-upload",accept:".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"}),e.jsxs(n,{type:"button",variant:"outline",className:"pointer-events-none",onClick:e=>e.stopPropagation(),children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"Select Files"]})]}),O.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-gray-800",children:["Attached Files (",O.length,")"]}),O.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(s.size/1024).toFixed(2)," KB"]})]})]}),e.jsx(n,{type:"button",variant:"ghost",size:"sm",onClick:()=>V(O.filter((e,s)=>s!==a)),className:"text-red-500 hover:text-red-700",children:e.jsx(he,{className:"w-4 h-4"})})]},a))]}),e.jsxs("div",{className:"bg-[#243d8a]/5 rounded-xl p-4 border border-[#243d8a]/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(se,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-semibold text-gray-800",children:"Design References"})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Link this requisition to design drawings or specifications"}),e.jsx(p,{placeholder:"Enter drawing number or reference ID",className:"bg-white border-gray-200",value:ee,onChange:e=>ae(e.target.value)})]})]})})]})]})}),e.jsx("div",{className:"bg-white border-t border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{type:"button",variant:"outline",onClick:a,className:"text-gray-600 border-gray-300 hover:bg-gray-50",children:"Cancel"}),e.jsxs("div",{className:"flex items-center gap-3",children:["details"!==B&&e.jsx(n,{type:"button",variant:"outline",onClick:()=>{"materials"===B&&_e("details"),"attachments"===B&&_e("materials")},className:"text-gray-600 border-gray-300 hover:bg-gray-50",children:"Previous"}),"details"===B&&e.jsxs(n,{type:"button",onClick:()=>{const e=P();e.project_id&&e.site_location&&e.requested_by&&e.date&&e.purpose?(Q(!0),_e("materials")):o.error("Please fill all required fields")},className:"bg-red-600 hover:bg-red-700 text-white",children:["Next: Materials",e.jsx(fe,{className:"w-4 h-4 ml-2"})]}),"materials"===B&&e.jsxs(n,{type:"button",onClick:()=>_e("attachments"),className:"bg-red-600 hover:bg-red-700 text-white",children:["Next: Attachments",e.jsx(fe,{className:"w-4 h-4 ml-2"})]}),"attachments"===B&&e.jsx(n,{type:"submit",className:"bg-red-600 hover:bg-red-700 text-white disabled:opacity-50 disabled:cursor-not-allowed",disabled:le,children:le?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-pulse",children:"Submitting..."}),e.jsx("div",{className:"w-4 h-4 ml-2 border-2 border-white border-t-transparent rounded-full animate-spin"})]}):e.jsxs(e.Fragment,{children:["Submit Request",e.jsx(be,{className:"w-4 h-4 ml-2"})]})})]})]})})]}),e.jsx(f,{open:ne,onOpenChange:de,children:e.jsxs(b,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(y,{children:[e.jsxs(v,{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-red-600"}),"Purchase Requisition Preview"]}),e.jsx(w,{children:"Review your purchase requisition before submission"})]}),e.jsxs("div",{className:"space-y-6 mt-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4"}),"Project Details"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Project ID:"}),e.jsx("span",{className:"ml-2 font-medium",children:G||"Not selected"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Site Location:"}),e.jsx("span",{className:"ml-2 font-medium",children:P("site_location")||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Requested By:"}),e.jsx("span",{className:"ml-2 font-medium",children:P("requested_by")||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Date:"}),e.jsx("span",{className:"ml-2 font-medium",children:P("date")||"Not specified"})]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("span",{className:"text-gray-600",children:"Purpose:"}),e.jsx("p",{className:"mt-1 font-medium",children:P("purpose")||"Not specified"})]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"}),"Materials (",$.length,")"]}),$.length>0?e.jsxs("div",{className:"space-y-2",children:[$.map((s,a)=>e.jsx("div",{className:"bg-white p-3 rounded border border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-medium text-sm",children:[a+1,". ",s.description]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[s.specification," | ",s.quantity," ",s.unit," Ã— AED ",s.cost]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(c,{className:De[s.priority],children:s.priority}),e.jsxs("p",{className:"text-sm font-semibold mt-1",children:["AED ",(s.quantity*s.cost).toFixed(2)]})]})]})},s.id)),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold",children:"Total Amount:"}),e.jsxs("span",{className:"text-lg font-bold text-red-600",children:["AED ",ye().toFixed(2)]})]})})]}):e.jsx("p",{className:"text-gray-500 text-sm",children:"No materials added"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),"Attachments (",O.length,")"]}),O.length>0?e.jsx("div",{className:"space-y-2",children:O.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{children:s.name}),e.jsxs("span",{className:"text-gray-500",children:["(",(s.size/1024).toFixed(2)," KB)"]})]},a))}):e.jsx("p",{className:"text-gray-500 text-sm",children:"No files attached"}),ee&&e.jsxs("div",{className:"mt-3 pt-3 border-t",children:[e.jsx("span",{className:"text-gray-600 text-sm",children:"Design Reference:"}),e.jsx("p",{className:"font-medium text-sm mt-1",children:ee})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx(n,{variant:"outline",onClick:()=>de(!1),children:"Close"}),e.jsx(n,{onClick:()=>{de(!1),u(Se)()},className:"bg-red-600 hover:bg-red-700 text-white disabled:opacity-50 disabled:cursor-not-allowed",disabled:!ve()||!we()||le,children:le?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"animate-pulse",children:"Submitting..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Submit Now"]})})]})]})})]})},Oe=()=>{a();const[d,x]=s.useState([]),[h,y]=s.useState([]),[v,w]=s.useState(!1),[A,T]=s.useState("newest"),[$,I]=s.useState("pending"),[O,U]=s.useState(null),[V,B]=s.useState(!1),[H,G]=s.useState(!1),[K,Q]=s.useState(null),[J,W]=s.useState(!1),[Y,Z]=s.useState(!1),[ee,se]=s.useState(null),[ae,te]=s.useState(""),[re,le]=s.useState(!1),[ie,ce]=s.useState("all"),[ne,de]=s.useState("all"),[oe,me]=s.useState("all"),[xe,pe]=s.useState("all"),[ue,je]=s.useState({isOpen:!1,purchaseId:null,type:"email"}),[Ne,fe]=s.useState({isOpen:!1,message:""}),[be,De]=s.useState(null),[qe,Pe]=s.useState({totalPurchases:0,pendingCount:0,approvedCount:0,rejectedCount:0,totalValue:0,emailSentCount:0,completedCount:0});s.useEffect(()=>{Le()},[]),s.useEffect(()=>{ke()},[d,A,$,ae,ie,ne,oe,xe]),s.useEffect(()=>{Ee()},[d]);const Le=async()=>{w(!0);try{const e=await Me.getPurchases();x(e),o.success(`Loaded ${e.length} purchase requests`)}catch(e){o.error(e.message||"Failed to load purchases")}finally{w(!1)}},ke=()=>{let e=[...d];switch($){case"pending":e=e.filter(e=>!("pending"!==e.status&&e.status||e.email_sent));break;case"email-sent":e=e.filter(e=>{if(!e.email_sent)return!1;if(e.latest_status){const s=e.latest_status.status?.toLowerCase(),a=e.latest_status.sender_latest_status?.toLowerCase();return!("completed"===s||"completed"===a||"delivered"===s||"closed"===s||"finished"===s)}const s=e.status?.toLowerCase();return!("completed"===s||"delivered"===s||"closed"===s||"finished"===s)});break;case"completed":e=e.filter(e=>{if(e.latest_status){const s=e.latest_status.status?.toLowerCase(),a=e.latest_status.sender_latest_status?.toLowerCase();return"completed"===s||"completed"===a||"delivered"===s||"closed"===s||"finished"===s}const s=e.status?.toLowerCase();return"completed"===s||"delivered"===s||"closed"===s||"finished"===s})}if(ae){const s=ae.toLowerCase();e=e.filter(e=>{const a=e.purchase_id?e.purchase_id.toString():"",t=e.purpose||"",r=e.site_location||"",l=e.project_id?e.project_id.toString():"",i=e.requested_by||"",c=a.includes(s)||t.toLowerCase().includes(s)||r.toLowerCase().includes(s)||l.toLowerCase().includes(s)||i.toLowerCase().includes(s),n=e.materials?.some(e=>{const a=e.description||"",t=e.category||"";return a.toLowerCase().includes(s)||t.toLowerCase().includes(s)})||!1;return c||n})}if("all"!==ie&&(e=e.filter(e=>e.status===ie)),"all"!==ne&&(e=e.filter(e=>e.project_id===ne)),"all"!==oe&&(e=e.filter(e=>e.site_location===oe)),"all"!==xe){const s=new Date,a=e=>{const a=new Date(e);switch(xe){case"today":return a.toDateString()===s.toDateString();case"week":return a>=new Date(s.getTime()-6048e5);case"month":return a>=new Date(s.getTime()-2592e6);case"quarter":return a>=new Date(s.getTime()-7776e6);default:return!0}};e=e.filter(e=>a(e.date||e.created_at))}e.sort((e,s)=>{const a=e=>e.last_modified_at?new Date(e.last_modified_at).getTime():e.created_at?new Date(e.created_at).getTime():new Date(e.date).getTime(),t=a(e),r=a(s);return"newest"===A?r-t:t-r}),y(e)},Ee=()=>{const e=d.length,s=d.filter(e=>!("pending"!==e.status&&e.status||e.email_sent)).length,a=d.filter(e=>"approved"===e.status).length,t=d.filter(e=>"rejected"===e.status).length,r=d.filter(e=>{if(!e.email_sent)return!1;if(e.latest_status){const s=e.latest_status.status?.toLowerCase(),a=e.latest_status.sender_latest_status?.toLowerCase();return!("completed"===s||"completed"===a||"delivered"===s||"closed"===s||"finished"===s)}const s=e.status?.toLowerCase();return!("completed"===s||"delivered"===s||"closed"===s||"finished"===s)}).length,l=d.filter(e=>{if(e.latest_status){const s=e.latest_status.status?.toLowerCase(),a=e.latest_status.sender_latest_status?.toLowerCase();return"completed"===s||"completed"===a||"delivered"===s||"closed"===s||"finished"===s}const s=e.status?.toLowerCase();return"completed"===s||"delivered"===s||"closed"===s||"finished"===s}).length,i=d.reduce((e,s)=>e+(s.materials?.reduce((e,s)=>e+s.cost*s.quantity,0)||0),0);Pe({totalPurchases:e,pendingCount:s,approvedCount:a,rejectedCount:t,totalValue:i,emailSentCount:r,completedCount:l})},Fe=e=>{U(e),B(!0)},Ae=e=>{Q(e),G(!0)},Oe=async e=>{const s=d.find(s=>s.purchase_id===e);s?"approved"!==s.status?s.email_sent?o.error("Cannot edit purchase requests that have been sent via email"):(se(s),Z(!0)):o.error("Cannot edit approved purchase requests"):o.error("Purchase not found")},Ue=async e=>{const s=d.find(s=>s.purchase_id===e);s?"approved"!==s.status?s.email_sent?o.error("Cannot delete purchase requests that have been sent via email"):je({isOpen:!0,purchaseId:e,type:"delete"}):o.error("Cannot delete approved purchase requests"):o.error("Purchase not found")},ze=e=>{je({isOpen:!0,purchaseId:e,type:"email"})},Ve=()=>""!==ae||"all"!==ie||"all"!==ne||"all"!==oe||"all"!==xe;return v&&0===d.length?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(m,{variant:"pulse-wave",size:"lg"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Loading purchases..."})]})}):e.jsxs("div",{className:"p-4 sm:p-6 bg-gray-50 min-h-screen [&_*:focus]:outline-none [&_*:focus]:ring-0",children:[e.jsx("div",{className:"mb-6 space-y-4",children:e.jsx(L.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-red-50 to-red-100 rounded-xl shadow-xl p-6 text-gray-800 border border-red-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-white/20 rounded-lg backdrop-blur",children:e.jsx(R,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Purchase Management Hub"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage and track all your purchase requests"})]})]}),e.jsxs(n,{onClick:()=>W(!0),className:"bg-red-600 hover:bg-red-700 text-white whitespace-nowrap shadow-lg",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"New Purchase Request"]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6",children:[e.jsxs(t,{className:"hover:shadow-md transition-shadow",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(i,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-red-500"}),"Total Purchases"]})}),e.jsx(r,{children:e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:qe.totalPurchases})})]}),e.jsxs(t,{className:"hover:shadow-md transition-shadow",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(i,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-yellow-500"}),"Pending"]})}),e.jsx(r,{children:e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:qe.pendingCount})})]}),e.jsxs(t,{className:"hover:shadow-md transition-shadow",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(i,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4 text-green-500"}),"Approved"]})}),e.jsx(r,{children:e.jsx("p",{className:"text-2xl font-bold text-green-600",children:qe.approvedCount})})]}),e.jsxs(t,{className:"hover:shadow-md transition-shadow",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(i,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4 text-red-500"}),"Rejected"]})}),e.jsx(r,{children:e.jsx("p",{className:"text-2xl font-bold text-red-600",children:qe.rejectedCount})})]}),e.jsxs(t,{className:"hover:shadow-md transition-shadow",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(i,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-blue-500"}),"Email Sent"]})}),e.jsx(r,{children:e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:qe.emailSentCount})})]}),e.jsxs(t,{className:"hover:shadow-md transition-shadow",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(i,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[e.jsx(M,{className:"h-4 w-4 text-green-500"}),"Total Value"]})}),e.jsx(r,{children:e.jsx("p",{className:"text-lg font-bold text-green-600",children:(Be=qe.totalValue,`AED ${Be.toLocaleString()}`)})})]})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(we,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(p,{type:"text",placeholder:"Search by PR#, purpose, location, project, or material...",value:ae,onChange:e=>te(e.target.value),className:"pl-10 pr-10"}),ae&&e.jsx("button",{onClick:()=>te(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600","aria-label":"Clear search",title:"Clear search",children:e.jsx(he,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{onClick:()=>le(!re),variant:Ve()?"default":"outline",className:Ve()?"bg-red-600 hover:bg-red-700":"",children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Filters",Ve()&&e.jsx(c,{variant:"secondary",className:"ml-2 bg-white text-red-600",children:"Active"})]}),e.jsxs(_,{value:A,onValueChange:e=>T(e),children:[e.jsx(C,{className:"w-[140px]",children:e.jsx(S,{placeholder:"Sort"})}),e.jsxs(D,{children:[e.jsx(q,{value:"newest",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-3.5 w-3.5"}),"Newest First"]})}),e.jsx(q,{value:"oldest",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 rotate-180"}),"Oldest First"]})})]})]}),e.jsx(n,{onClick:Le,disabled:v,variant:"outline",children:e.jsx(Se,{className:"h-4 w-4 "+(v?"animate-spin":"")})})]})]}),e.jsx(k,{children:re&&e.jsx(L.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsxs(t,{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Status"}),e.jsxs(_,{value:ie,onValueChange:ce,children:[e.jsx(C,{children:e.jsx(S,{placeholder:"All Status"})}),e.jsxs(D,{children:[e.jsx(q,{value:"all",children:"All Status"}),e.jsx(q,{value:"pending",children:"Pending"}),e.jsx(q,{value:"approved",children:"Approved"}),e.jsx(q,{value:"rejected",children:"Rejected"}),e.jsx(q,{value:"under_review",children:"Under Review"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Project"}),e.jsxs(_,{value:ne,onValueChange:de,children:[e.jsx(C,{children:e.jsx(S,{placeholder:"All Projects"})}),e.jsxs(D,{children:[e.jsx(q,{value:"all",children:"All Projects"}),[...new Set(d.map(e=>e.project_id))].filter(Boolean).map(s=>e.jsx(q,{value:s,children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-3 w-3"}),s]})},s))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Location"}),e.jsxs(_,{value:oe,onValueChange:me,children:[e.jsx(C,{children:e.jsx(S,{placeholder:"All Locations"})}),e.jsxs(D,{children:[e.jsx(q,{value:"all",children:"All Locations"}),[...new Set(d.map(e=>e.site_location))].filter(Boolean).map(s=>e.jsx(q,{value:s,children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-3 w-3"}),s]})},s))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Date Range"}),e.jsxs(_,{value:xe,onValueChange:pe,children:[e.jsx(C,{children:e.jsx(S,{placeholder:"All Time"})}),e.jsxs(D,{children:[e.jsx(q,{value:"all",children:"All Time"}),e.jsx(q,{value:"today",children:"Today"}),e.jsx(q,{value:"week",children:"Last 7 Days"}),e.jsx(q,{value:"month",children:"Last 30 Days"}),e.jsx(q,{value:"quarter",children:"Last 90 Days"})]})]})]})]}),Ve()&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs(n,{onClick:()=>{te(""),ce("all"),de("all"),me("all"),pe("all"),le(!1)},variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Clear All Filters"]})})]})})})]}),e.jsxs(u,{value:$,onValueChange:I,className:"space-y-4",children:[e.jsxs(g,{className:"grid w-full grid-cols-3 h-auto max-w-lg",children:[e.jsxs(j,{value:"pending",className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3.5 w-3.5"}),"Pending (",qe.pendingCount,")"]}),e.jsxs(j,{value:"email-sent",className:"flex items-center gap-1",children:[e.jsx(E,{className:"h-3.5 w-3.5"}),"Email Sent (",qe.emailSentCount,")"]}),e.jsxs(j,{value:"completed",className:"flex items-center gap-1 text-green-600 data-[state=active]:text-green-700",children:[e.jsx(ye,{className:"h-3.5 w-3.5"}),"Completed (",qe.completedCount||0,")"]})]}),e.jsx(N,{value:$,className:"space-y-4",children:h.length>0?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:e.jsx(k,{mode:"popLayout",children:h.map(s=>e.jsx(Te,{purchase:s,onViewDetails:Fe,onViewHistory:Ae,onEdit:Oe,onDelete:Ue,onSendEmail:ze,isLoading:v,isSendingEmail:be===s.purchase_id},s.purchase_id))})}):e.jsx(t,{className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(R,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No purchases found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"pending"===$?"No pending purchase requests":"email-sent"===$?"No email sent purchases":"No completed purchases"}),e.jsxs(n,{onClick:()=>W(!0),className:"mt-4 bg-red-600 hover:bg-red-700",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Create Purchase Request"]})]})})})]}),e.jsx(f,{open:J,onOpenChange:W,children:e.jsx(b,{className:"max-w-4xl max-h-[80vh] overflow-y-auto p-0",hideCloseButton:!0,children:e.jsx(Ie,{onClose:()=>{W(!1),Le()},showAsPage:!1})})}),e.jsx(f,{open:Y,onOpenChange:Z,children:e.jsx(b,{className:"max-w-4xl max-h-[80vh] overflow-y-auto p-0",hideCloseButton:!0,children:e.jsx(Ie,{onClose:()=>{Z(!1),se(null),Le()},showAsPage:!1,editMode:!0,purchaseData:ee})})}),e.jsx(Re,{isOpen:V,onClose:()=>{B(!1),U(null)},purchaseId:O,mode:"details"}),e.jsx($e,{isOpen:H,onClose:()=>{G(!1),Q(null)},purchaseId:K}),e.jsx(P,{isOpen:ue.isOpen,onClose:()=>je({isOpen:!1,purchaseId:null,type:"email"}),type:"email"===ue.type?"email":"warning",title:"email"===ue.type?"Send Email Confirmation":"Delete Confirmation",message:"email"===ue.type?"Are you sure you want to send this purchase request via email to the procurement team?":"Are you sure you want to delete this purchase request? This action cannot be undone.",confirmText:"email"===ue.type?"Send Email":"Delete",cancelText:"Cancel",showCancel:!0,onConfirm:"email"===ue.type?async()=>{if(!ue.purchaseId)return;const e=ue.purchaseId;je({isOpen:!1,purchaseId:null,type:"email"}),De(e);try{await Me.sendPurchaseEmail(e),fe({isOpen:!0,message:"Email has been sent successfully to the procurement team!"});const s=(new Date).toISOString();x(a=>a.map(a=>a.purchase_id===e?{...a,email_sent:!0,last_modified_at:s,last_modified_by:"Site Supervisor"}:a))}catch(s){o.error(s.message||"Failed to send email")}finally{De(null)}}:async()=>{if(!ue.purchaseId)return;const e=ue.purchaseId;je({isOpen:!1,purchaseId:null,type:"delete"}),w(!0);try{await Me.deletePurchase(e),fe({isOpen:!0,message:"Purchase request has been deleted successfully!"}),x(s=>s.filter(s=>s.purchase_id!==e))}catch(s){o.error(s.message||"Failed to delete purchase request")}finally{w(!1)}}}),e.jsx(P,{isOpen:Ne.isOpen,onClose:()=>fe({isOpen:!1,message:""}),type:"success",message:Ne.message,confirmText:"OK",showCancel:!1})]});var Be};export{Oe as default};
