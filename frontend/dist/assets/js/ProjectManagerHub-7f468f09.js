import{j as e}from"./radix-ui-34961435.js";import{u as t,r as s}from"./react-vendor-3707ac94.js";import{T as a,a as r,b as l,c as n}from"./tabs-8d248749.js";import{t as i,B as c,a as o,M as d}from"./index-12cad093.js";import{I as u}from"./input-dbd0a11e.js";import{A as m,a as p}from"./alert-409df19c.js";import{C as g,b as h,c as j,a as x}from"./card-e62b6216.js";import{S as v,a as b,b as w,c as y,d as f}from"./select-767f455e.js";import{P as _}from"./PurchaseApprovalCard-09fd0945.js";import{P as N}from"./PurchaseDetailsModal-bb395d44.js";import{p as C}from"./projectManagerService-fd1f363b.js";import{C as S}from"./confirmation-dialog-0228c1b8.js";import{g as T,k,i as A,v as P,F as D,T as E,N as R,af as L,X as M,w as F}from"./icons-2fde7931.js";import{m as O,A as V}from"./ui-vendor-42d562f2.js";import"./auth-f9290e45.js";import"./utils-8e4480a0.js";import"./forms-337f692b.js";import"./textarea-ff7bd289.js";import"./dialog-d443819a.js";import"./label-d100d551.js";import"./dateFormatter-3b370b4b.js";const q=({metric:t})=>e.jsx(O.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${t.bgColor} rounded-lg p-4 border border-gray-100`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:t.title}),e.jsx("p",{className:"text-xl font-bold text-gray-900 mt-1",children:t.value}),t.trend&&e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(E,{className:"h-4 w-4 "+("up"===t.trendType?"text-green-600":"down"===t.trendType?"text-red-600":"text-gray-600")}),e.jsx("span",{className:"text-sm ml-1 "+("up"===t.trendType?"text-green-600":"down"===t.trendType?"text-red-600":"text-gray-600"),children:t.trend})]})]}),e.jsx("div",{className:`${t.iconColor} p-2 rounded-lg`,children:t.icon})]})}),z=()=>{t();const[z,$]=s.useState("pending"),[B,H]=s.useState([]),[I,K]=s.useState([]),[J,Q]=s.useState([]),[U,G]=s.useState([]),[W,X]=s.useState([]),[Y,Z]=s.useState(!0),[ee,te]=s.useState(""),[se,ae]=s.useState(0),[re,le]=s.useState(!1),[ne,ie]=s.useState(""),[ce,oe]=s.useState(!1),[de,ue]=s.useState("all"),[me,pe]=s.useState("all"),[ge,he]=s.useState("all"),[je,xe]=s.useState("all"),[ve,be]=s.useState(!1),[we,ye]=s.useState(null),[fe,_e]=s.useState("details"),[Ne,Ce]=s.useState({isOpen:!1,message:""}),[Se,Te]=s.useState({approving:new Set,rejecting:new Set,resending:new Set}),ke=s.useCallback(async()=>{try{Z(!0),le(!1),ie("");const t=await C.getProcurementApprovedPurchases();if(t.success){const s=(t.approved_procurement_purchases||[]).map(e=>{const t=e.status_history&&e.status_history.length>0?e.status_history[e.status_history.length-1]:null;return{...e,latest_status:t?{status:t.status,sender:t.sender,receiver:t.receiver,date:t.date}:void 0}}),a=s.filter(e=>"completed"===e.latest_status?.status||"complete"===e.latest_status?.status||!0===e.accounts_acknowledgement||"completed"===e.current_workflow_status),r=s.filter(e=>!("completed"===e.latest_status?.status||"complete"===e.latest_status?.status||!0===e.accounts_acknowledgement||"completed"===e.current_workflow_status));H(r),Q(a);const l=(t.estimation_pm_rejections||[]).map(e=>{const t=e.status_history&&e.status_history.length>0?e.status_history[e.status_history.length-1]:null;return{...e,latest_status:t?{status:t.status,sender:t.sender,receiver:t.receiver,date:t.date}:void 0}}).filter(e=>!("completed"===e.latest_status?.status||"complete"===e.latest_status?.status||!0===e.accounts_acknowledgement||"completed"===e.current_workflow_status)&&"rejected"!==e.pm_status);K(l);const n=r.filter(e=>!e.pm_status||"pending"===e.pm_status),i=r.filter(e=>"approved"===e.pm_status),c=r.filter(e=>"rejected"===e.pm_status),o=t.overall_total_quantity||0,d=t.overall_total_cost||0,u=[{title:"Total Purchases",value:t.total_approved_procurement_purchases||0,icon:e.jsx(T,{className:"h-5 w-5 text-blue-600"}),bgColor:"bg-blue-50",iconColor:"bg-blue-100",trend:"+12%",trendType:"up"},{title:"Pending Approvals",value:n.length,icon:e.jsx(k,{className:"h-5 w-5 text-yellow-600"}),bgColor:"bg-yellow-50",iconColor:"bg-yellow-100",trend:"-5%",trendType:"down"},{title:"Approved",value:i.length,icon:e.jsx(A,{className:"h-5 w-5 text-green-600"}),bgColor:"bg-green-50",iconColor:"bg-green-100",trend:"+8%",trendType:"up"},{title:"Rejected",value:c.length,icon:e.jsx(P,{className:"h-5 w-5 text-red-600"}),bgColor:"bg-red-50",iconColor:"bg-red-100",trend:"-2%",trendType:"down"},{title:"Completed",value:a.length,icon:e.jsx(D,{className:"h-5 w-5 text-blue-600"}),bgColor:"bg-blue-50",iconColor:"bg-blue-100",trend:"+10%",trendType:"up"},{title:"Total Quantity",value:o.toLocaleString(),icon:e.jsx(T,{className:"h-5 w-5 text-purple-600"}),bgColor:"bg-purple-50",iconColor:"bg-purple-100",trend:"+7%",trendType:"up"},{title:"Total Value",value:`AED ${d.toLocaleString()}`,icon:e.jsx(E,{className:"h-5 w-5 text-indigo-600"}),bgColor:"bg-indigo-50",iconColor:"bg-indigo-100",trend:"+15%",trendType:"up"}];X(u)}}catch(t){le(!0),H([]),K([]),Q([]);X([{title:"Total Purchases",value:0,icon:e.jsx(T,{className:"h-5 w-5 text-blue-600"}),bgColor:"bg-blue-50",iconColor:"bg-blue-100",trend:"N/A",trendType:"neutral"},{title:"Pending Approvals",value:0,icon:e.jsx(k,{className:"h-5 w-5 text-yellow-600"}),bgColor:"bg-yellow-50",iconColor:"bg-yellow-100",trend:"N/A",trendType:"neutral"},{title:"Approved",value:0,icon:e.jsx(A,{className:"h-5 w-5 text-green-600"}),bgColor:"bg-green-50",iconColor:"bg-green-100",trend:"N/A",trendType:"neutral"},{title:"Rejected",value:0,icon:e.jsx(P,{className:"h-5 w-5 text-red-600"}),bgColor:"bg-red-50",iconColor:"bg-red-100",trend:"N/A",trendType:"neutral"}]);let s="An unknown error occurred";s=t instanceof Error&&t.message.includes("500")?"Server is temporarily unavailable. Please try again later.":t instanceof Error&&t.message.includes("Network Error")?"Network connection error. Please check your internet connection.":"Failed to fetch purchase requests. Please try again.",ie(s),i.error(s)}finally{Z(!1)}},[]);s.useCallback(()=>{ae(e=>e+1)},[]),s.useEffect(()=>{ke()},[se]),s.useEffect(()=>{let e=[];switch(z){case"pending":e=[...B].filter(e=>!e.pm_status||"pending"===e.pm_status);break;case"approved":e=[...B].filter(e=>"approved"===e.pm_status);break;case"rejected":e=[...B].filter(e=>"rejected"===e.pm_status);break;case"estimation_rejected":e=[...I];break;case"completed":e=[...J];break;default:e=[...B]}if(ee){const t=ee.toLowerCase();e=e.filter(e=>{const s=e.purchase_id?e.purchase_id.toString():"",a=e.purpose||"",r=e.site_location||"";return s.includes(t)||a.toLowerCase().includes(t)||r.toLowerCase().includes(t)})}if("all"!==de&&(e=e.filter(e=>(e.pm_status||e.current_workflow_status||"pending")===de)),"all"!==ge&&(e=e.filter(e=>e.site_location===ge)),"all"!==je){const t=new Date,s=e=>{const s=new Date(e);switch(je){case"today":return s.toDateString()===t.toDateString();case"week":return s>=new Date(t.getTime()-6048e5);case"month":return s>=new Date(t.getTime()-2592e6);default:return!0}};e=e.filter(e=>s(e.created_at||e.date))}switch(z){case"pending":case"estimation_rejected":e.sort((e,t)=>new Date(e.created_at||e.date||0).getTime()-new Date(t.created_at||t.date||0).getTime());break;case"approved":e.sort((e,t)=>{const s=new Date(e.pm_status_date||e.created_at||e.date||0).getTime();return new Date(t.pm_status_date||t.created_at||t.date||0).getTime()-s});break;case"rejected":e.sort((e,t)=>{const s=new Date(e.pm_status_date||e.created_at||e.date||0).getTime();return new Date(t.pm_status_date||t.created_at||t.date||0).getTime()-s});break;case"completed":e.sort((e,t)=>{const s=new Date(e.latest_status?.date||e.created_at||e.date||0).getTime();return new Date(t.latest_status?.date||t.created_at||t.date||0).getTime()-s});break;default:e.sort((e,t)=>{const s=new Date(e.created_at||e.date||0).getTime();return new Date(t.created_at||t.date||0).getTime()-s})}G(e)},[B,I,J,z,ee,de,me,ge,je]);const Ae=e=>{ye(e),_e("details"),be(!0)},Pe=e=>{ye(e),_e("history"),be(!0)},De=()=>""!==ee||"all"!==de||"all"!==me||"all"!==ge||"all"!==je,Ee=s.useMemo(()=>({pending:B.filter(e=>!e.pm_status||"pending"===e.pm_status).length,approved:B.filter(e=>"approved"===e.pm_status).length,rejected:B.filter(e=>"rejected"===e.pm_status).length,estimation_rejected:I.length,completed:J.length}),[B,I,J]);return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"px-6 py-4",children:e.jsx(O.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-[#243d8a]/5 to-[#243d8a]/10 rounded-xl shadow-xl p-6 border border-[#243d8a]/20",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-[#243d8a] rounded-lg shadow-lg",children:e.jsx(T,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-[#243d8a]",children:"Project Manager Hub"}),e.jsx("p",{className:"text-[#243d8a]/80 mt-1",children:"Manage purchase approvals and project workflows"})]})]})})}),e.jsx("div",{className:"px-6 py-6",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4",children:W.map((t,s)=>e.jsx(q,{metric:t},s))})}),e.jsx("div",{className:"px-6 pb-6",children:e.jsxs(g,{className:"shadow-sm",children:[e.jsx(h,{className:"border-b bg-gray-50/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(T,{className:"h-5 w-5 text-blue-600"}),e.jsx(j,{className:"text-lg",children:"Purchase Approvals"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(R,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(u,{type:"text",placeholder:"Search purchases...",value:ee,onChange:e=>te(e.target.value),className:"pl-9 w-64"})]}),e.jsxs(c,{onClick:()=>oe(!ce),variant:De()?"default":"outline",className:De()?"bg-blue-600 hover:bg-blue-700":"",size:"sm",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),"Filters",De()&&e.jsx(o,{variant:"secondary",className:"ml-2 bg-white text-blue-600",children:"Active"})]})]})]})}),e.jsx(V,{children:ce&&e.jsx(O.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden border-b",children:e.jsxs("div",{className:"p-4 bg-gray-50/30",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Status"}),e.jsxs(v,{value:de,onValueChange:ue,children:[e.jsx(b,{children:e.jsx(w,{placeholder:"All Status"})}),e.jsxs(y,{children:[e.jsx(f,{value:"all",children:"All Status"}),e.jsx(f,{value:"pending",children:"Pending"}),e.jsx(f,{value:"approved",children:"Approved"}),e.jsx(f,{value:"rejected",children:"Rejected"}),[...new Set([...B,...I,...J].map(e=>e.pm_status||e.current_workflow_status||"pending"))].filter(Boolean).map(t=>e.jsx(f,{value:t,children:t.charAt(0).toUpperCase()+t.slice(1)},t))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Location"}),e.jsxs(v,{value:ge,onValueChange:he,children:[e.jsx(b,{children:e.jsx(w,{placeholder:"All Locations"})}),e.jsxs(y,{children:[e.jsx(f,{value:"all",children:"All Locations"}),[...new Set([...B,...I,...J].map(e=>e.site_location))].filter(Boolean).map(t=>e.jsx(f,{value:t,children:t},t))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Date Range"}),e.jsxs(v,{value:je,onValueChange:xe,children:[e.jsx(b,{children:e.jsx(w,{placeholder:"All Time"})}),e.jsxs(y,{children:[e.jsx(f,{value:"all",children:"All Time"}),e.jsx(f,{value:"today",children:"Today"}),e.jsx(f,{value:"week",children:"Last 7 Days"}),e.jsx(f,{value:"month",children:"Last 30 Days"})]})]})]})]}),De()&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs(c,{onClick:()=>{te(""),ue("all"),pe("all"),he("all"),xe("all"),oe(!1)},variant:"outline",size:"sm",className:"text-blue-600 hover:text-blue-700 border-blue-200 hover:border-blue-300",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Clear All Filters"]})})]})})}),e.jsx(x,{className:"p-0",children:e.jsxs(a,{value:z,onValueChange:$,className:"w-full",children:[e.jsx("div",{className:"border-b px-6 pt-4",children:e.jsxs(r,{className:"grid w-full max-w-2xl grid-cols-5 bg-gray-100/50",children:[e.jsxs(l,{value:"pending",className:"relative",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Pending",Ee.pending>0&&e.jsx(o,{variant:"secondary",className:"ml-2 bg-yellow-100 text-yellow-700",children:Ee.pending})]}),e.jsxs(l,{value:"approved",className:"relative",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),"Approved",Ee.approved>0&&e.jsx(o,{variant:"secondary",className:"ml-2 bg-green-100 text-green-700",children:Ee.approved})]}),e.jsxs(l,{value:"rejected",className:"relative",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Rejected",Ee.rejected>0&&e.jsx(o,{variant:"secondary",className:"ml-2 bg-red-100 text-red-700",children:Ee.rejected})]}),e.jsxs(l,{value:"estimation_rejected",className:"relative",children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"Est. Rejected",Ee.estimation_rejected>0&&e.jsx(o,{variant:"secondary",className:"ml-2 bg-orange-100 text-orange-700",children:Ee.estimation_rejected})]}),e.jsxs(l,{value:"completed",className:"relative",children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),"Completed",Ee.completed>0&&e.jsx(o,{variant:"secondary",className:"ml-2 bg-blue-100 text-blue-700",children:Ee.completed})]})]})}),e.jsxs(n,{value:z,className:"p-6",children:["estimation_rejected"===z&&U.length>0&&e.jsxs(m,{className:"mb-4 border-orange-200 bg-orange-50",children:[e.jsx(F,{className:"h-4 w-4 text-orange-600"}),e.jsx(p,{className:"text-orange-800",children:"These purchases were rejected by the Estimation team. Review their feedback and take appropriate action."})]}),Y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(d,{variant:"pulse-wave",size:"md"})}):0===U.length?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(T,{className:"h-12 w-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No purchases found"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:U.map(t=>e.jsx(_,{purchase:t,onViewDetails:Ae,onViewHistory:Pe,onEdit:()=>{return e=t.purchase_id,void i.info(`Edit functionality for purchase ${e}`);var e},onApprove:()=>(async e=>{Te(t=>({...t,approving:new Set(t.approving).add(e)}));try{(await C.approvePurchase(e,"Approved by Project Manager")).success&&(Ce({isOpen:!0,message:"Purchase request has been approved successfully and sent to the next workflow stage!"}),ae(e=>e+1))}catch(t){i.error("Failed to approve purchase")}finally{Te(t=>{const s=new Set(t.approving);return s.delete(e),{...t,approving:s}})}})(t.purchase_id),onReject:e=>(async(e,t)=>{Te(t=>({...t,rejecting:new Set(t.rejecting).add(e)}));try{const s=B.find(t=>t.purchase_id===e);if("rejected"===s?.pm_status)return void i.warning("This purchase has already been rejected by Project Manager");(await C.rejectPurchase(e,t,"Rejected by Project Manager")).success&&(Ce({isOpen:!0,message:"Purchase request has been rejected and sent back to the requester for revision!"}),ae(e=>e+1))}catch(s){const e=s.message||"Failed to reject purchase";i.error(e)}finally{Te(t=>{const s=new Set(t.rejecting);return s.delete(e),{...t,rejecting:s}})}})(t.purchase_id,e),onSendToEstimation:()=>(async e=>{Te(t=>({...t,resending:new Set(t.resending).add(e)}));try{const t=I.find(t=>t.purchase_id===e);if("rejected"===t?.pm_status)return void i.error("Cannot resend: This purchase was rejected by Project Manager. Please approve it from the Pending tab first.");const s=await C.resendToEstimation(e,"Reviewed and resending to Estimation for further review");s.success||s.message?.includes("successfully")?(Ce({isOpen:!0,message:"Purchase request has been resent to Estimation team for further review!"}),ae(e=>e+1)):i.error(s.message||s.error||"Failed to resend to Estimation")}catch(t){let e="Failed to resend to Estimation";"object"==typeof t&&null!==t&&(t.error?e=t.error:t.message?e=t.message:t.response?.data?.error?e=t.response.data.error:t.response?.data?.message&&(e=t.response.data.message)),i.error(e)}finally{Te(t=>{const s=new Set(t.resending);return s.delete(e),{...t,resending:s}})}})(t.purchase_id),isLoading:Se.approving.has(t.purchase_id)||Se.rejecting.has(t.purchase_id)||Se.resending.has(t.purchase_id),isApproving:Se.approving.has(t.purchase_id),isRejecting:Se.rejecting.has(t.purchase_id),isResending:Se.resending.has(t.purchase_id),isEstimationRejected:"estimation_rejected"===z},t.purchase_id))})]})]})})]})}),e.jsx(N,{isOpen:ve,onClose:()=>{be(!1),ye(null)},purchaseId:we,mode:fe}),e.jsx(S,{isOpen:Ne.isOpen,onClose:()=>Ce({isOpen:!1,message:""}),type:"success",message:Ne.message,confirmText:"OK",showCancel:!1})]})};export{z as default};
