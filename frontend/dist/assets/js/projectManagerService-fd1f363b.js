var e=Object.defineProperty,a=(a,t,r)=>(((a,t,r)=>{t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r})(a,"symbol"!=typeof t?t+"":t,r),r);import{b as t}from"./index-12cad093.js";const r=new class{constructor(){a(this,"pendingRequests",new Map),a(this,"TTL",1e3)}deduplicate(e,a){this.cleanupOldRequests();const t=this.pendingRequests.get(e);if(t)return t.promise;const r=a().finally(()=>{this.pendingRequests.delete(e)});return this.pendingRequests.set(e,{promise:r,timestamp:Date.now()}),r}cleanupOldRequests(){const e=Date.now();for(const[a,t]of this.pendingRequests.entries())e-t.timestamp>this.TTL&&this.pendingRequests.delete(a)}clear(){this.pendingRequests.clear()}};const s=new class{async getProcurementApprovedPurchases(){return r.deduplicate("pm_purchases",async()=>{try{return(await t.get("/projectmanger_purchases")).data}catch(e){throw e}})}async approvePurchase(e,a){try{return(await t.post("/pm_approval",{purchase_id:e,purchase_status:"approved",comments:a||""})).data}catch(r){throw r}}async rejectPurchase(e,a,r){try{return(await t.post("/pm_approval",{purchase_id:e,purchase_status:"rejected",rejection_reason:a,comments:r||""})).data}catch(s){if(s.response?.data?.error){const e=s.response.data.error;if(e.toLowerCase().includes("already rejected")||e.toLowerCase().includes("has already rejected"))throw new Error("This purchase has already been rejected by Project Manager. No further action needed.");if(e.toLowerCase().includes("already approved"))throw new Error('Cannot reject: This purchase was already approved and is awaiting estimation review. Use "Resend to Est" instead.');throw new Error(e)}throw s}}async getPurchaseDetails(e){try{const a=await t.get(`/purchase/${e}`);if(a.data){if(void 0!==a.data.success){if(a.data.success)return a.data;throw new Error(a.data.message||"Failed to fetch purchase details")}return a.data}throw new Error("Failed to fetch purchase details")}catch(a){if(404===a.response?.status){if("User not found"===a.response?.data?.error)throw new Error(`Purchase request #${e} has data inconsistency. The associated user account may have been deleted.`);throw new Error(`Purchase request #${e} not found. It may have been deleted or the ID is incorrect.`)}if(a.response?.data?.message)throw new Error(a.response.data.message);if(a.response?.data?.error)throw new Error(a.response.data.error);throw a}}async getPurchaseHistory(e){try{const a=await t.get(`/purchase_history/${e}`);if(a.data.success)return{purchase:a.data.purchase};throw new Error(a.data.message||"Failed to fetch purchase history")}catch(a){throw a}}async getPMDashboardData(){try{const e=await t.get("/project_manager_dashboard");if(e.data.success){const a=e.data.dashboard_data;return{totalPurchases:a.total_purchases||0,pendingApprovals:a.pending_pm_count||0,approvedThisMonth:a.pm_approved_this_month||0,rejectedThisMonth:a.pm_rejected_this_month||0,averageApprovalTime:a.average_approval_time||0,recentPurchases:a.recent_purchases||[],approvalTrends:a.approval_trends||[],categoryBreakdown:a.category_breakdown||[]}}const a=e.data.approved_procurement_purchases||[],r=new Date,s=r.getMonth(),o=r.getFullYear(),n=a.filter(e=>{const a=new Date(e.created_at);return a.getMonth()===s&&a.getFullYear()===o}),c=a.filter(e=>"pending"===e.pm_status||null===e.pm_status).length,p=n.filter(e=>"approved"===e.pm_status).length,i=n.filter(e=>"rejected"===e.pm_status).length,d=new Map;a.forEach(e=>{e.materials_summary&&e.materials_summary.categories&&e.materials_summary.categories.forEach(a=>{const t=d.get(a)||{count:0,value:0};d.set(a,{count:t.count+1,value:t.value+e.materials_summary.total_cost/e.materials_summary.categories.length})})});const h=Array.from(d.entries()).map(([e,a])=>({category:e,count:a.count,value:Math.round(a.value)})),u=["Jan","Feb","Mar","Apr","May","Jun"].map(e=>({month:e,approved:Math.floor(20*Math.random())+10,rejected:Math.floor(10*Math.random())+2,pending:Math.floor(15*Math.random())+5}));return{totalPurchases:a.length,pendingApprovals:c,approvedThisMonth:p,rejectedThisMonth:i,averageApprovalTime:2.5,recentPurchases:a.slice(0,10),approvalTrends:u,categoryBreakdown:h}}catch(e){try{const e=(await this.getProcurementApprovedPurchases()).approved_procurement_purchases||[],a=new Date,t=a.getMonth(),r=a.getFullYear(),s=e.filter(e=>{const a=new Date(e.created_at);return a.getMonth()===t&&a.getFullYear()===r}),o=e.filter(e=>"pending"===e.pm_status||null===e.pm_status).length,n=s.filter(e=>"approved"===e.pm_status).length,c=s.filter(e=>"rejected"===e.pm_status).length,p=new Map;e.forEach(e=>{e.materials_summary&&e.materials_summary.categories&&e.materials_summary.categories.forEach(a=>{const t=p.get(a)||{count:0,value:0};p.set(a,{count:t.count+1,value:t.value+e.materials_summary.total_cost/e.materials_summary.categories.length})})});const i=Array.from(p.entries()).map(([e,a])=>({category:e,count:a.count,value:Math.round(a.value)})),d=["Jan","Feb","Mar","Apr","May","Jun"].map(e=>({month:e,approved:Math.floor(20*Math.random())+10,rejected:Math.floor(10*Math.random())+2,pending:Math.floor(15*Math.random())+5}));return{totalPurchases:e.length,pendingApprovals:o,approvedThisMonth:n,rejectedThisMonth:c,averageApprovalTime:2.5,recentPurchases:e.slice(0,10),approvalTrends:d,categoryBreakdown:i}}catch(a){return{totalPurchases:0,pendingApprovals:0,approvedThisMonth:0,rejectedThisMonth:0,averageApprovalTime:0,recentPurchases:[],approvalTrends:[],categoryBreakdown:[]}}}}async resendToEstimation(e,a){try{return(await t.post("/pm_approval",{purchase_id:e,purchase_status:"approved",comments:a||"Reviewed estimation feedback and resending for further review"})).data}catch(r){const e=r.response?.data?.error||"";if(e.toLowerCase().includes("already approved"))return{success:!0,message:"Purchase is already approved and in estimation review"};if(e.toLowerCase().includes("already rejected")||e.toLowerCase().includes("has already rejected"))throw new Error("This purchase was previously rejected by you. Please approve it first from the Pending tab before resending to Estimation.");if(r.response?.data)throw r.response.data;throw r}}};export{s as p};
